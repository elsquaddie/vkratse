# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

---

# ü§ñ –ß—Ç–æ –±—ã–ª–æ –≤ —á–∞—Ç–µ - Telegram Bot

## üìã –û –ø—Ä–æ–µ–∫—Ç–µ

**Telegram –±–æ—Ç –¥–ª—è AI-—Å–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ª–∏—á–Ω–æ—Å—Ç—è–º–∏.**

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:
- **Backend**: Python 3.11+, Vercel Serverless Functions
- **Database**: Supabase (PostgreSQL)
- **AI**: Claude API (Anthropic)
- **Bot Framework**: python-telegram-bot
- **Deployment**: Vercel (webhook mode)

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏ AI (7 –±–∞–∑–æ–≤—ã—Ö + –∫–∞—Å—Ç–æ–º–Ω—ã–µ)
- –°–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —á–∞—Ç–æ–≤ –∑–∞ —Ä–∞–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã
- –°—É–¥–µ–π—Å—Ç–≤–æ —Å–ø–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ /rassudi
- –í—ã–±–æ—Ä —á–∞—Ç–æ–≤ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
- –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (2 –¥–Ω—è)
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–æ–≤–µ—Ä–∫–∏ —á–ª–µ–Ω—Å—Ç–≤–∞, HMAC, sanitization)

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### –ü—Ä–∏–Ω—Ü–∏–ø—ã:
1. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –∫–∞–∂–¥–∞—è —Ñ–∏—á–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ
2. **–°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å** - –º–∏–Ω–∏–º—É–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
3. **–¢–∏–ø–∏–∑–∞—Ü–∏—è** - type hints –≤–µ–∑–¥–µ
4. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ—Å—Ç—å** - –≤—Å—ë —á–µ—Ä–µ–∑ config.py
5. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –º–æ–¥—É–ª–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:

```
vkratse/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ index.py              # Webhook entry point (Vercel handler)
‚îÇ
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ summaries.py          # /sut –ª–æ–≥–∏–∫–∞ + callback handlers
‚îÇ   ‚îú‚îÄ‚îÄ personalities.py      # /lichnost + —Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ judge.py              # /rassudi - —Å—É–¥–µ–π—Å—Ç–≤–æ —Å–ø–æ—Ä–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ commands.py           # /start, /help, /stats
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ ai_service.py         # –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ Claude API
‚îÇ   ‚îú‚îÄ‚îÄ db_service.py         # –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ Supabase
‚îÇ   ‚îî‚îÄ‚îÄ persistence.py        # User data persistence
‚îÇ
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ message.py            # –ú–æ–¥–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ personality.py        # –ú–æ–¥–µ–ª—å –ª–∏—á–Ω–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ user.py               # –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îî‚îÄ‚îÄ chat.py               # –ú–æ–¥–µ–ª—å —á–∞—Ç–∞
‚îÇ
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ security.py           # HMAC, sanitization
‚îÇ   ‚îú‚îÄ‚îÄ rate_limit.py         # Rate limiting
‚îÇ   ‚îú‚îÄ‚îÄ cooldown.py           # Cooldown —á–∞—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ time_parser.py        # –ü–∞—Ä—Å–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ validators.py         # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ cleanup_old_messages.py  # –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ –ë–î
‚îÇ
‚îú‚îÄ‚îÄ sql/
‚îÇ   ‚îú‚îÄ‚îÄ init_tables.sql       # –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
‚îÇ   ‚îî‚îÄ‚îÄ seed_personalities.sql # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π
‚îÇ
‚îú‚îÄ‚îÄ config.py                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (env vars)
‚îú‚îÄ‚îÄ requirements.txt          # Python dependencies
‚îú‚îÄ‚îÄ vercel.json              # Vercel configuration
‚îú‚îÄ‚îÄ README.md                # –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îî‚îÄ‚îÄ README_CLEANUP.md        # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ cleanup —Å–∫—Ä–∏–ø—Ç—É
```

---

## üóÑÔ∏è –°–•–ï–ú–ê –î–ê–ù–ù–´–• (Supabase)

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

#### `messages`
```sql
CREATE TABLE messages (
  id BIGSERIAL PRIMARY KEY,
  chat_id BIGINT NOT NULL,
  user_id BIGINT,
  username TEXT,
  message_text TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  INDEX idx_chat_time (chat_id, created_at DESC)
);
```
**–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞:** 2 –¥–Ω—è (–ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏)

#### `personalities`
```sql
CREATE TABLE personalities (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) UNIQUE NOT NULL,
  display_name VARCHAR(100) NOT NULL,
  emoji VARCHAR(10) DEFAULT 'üé≠',
  system_prompt TEXT NOT NULL,
  is_custom BOOLEAN DEFAULT FALSE,
  created_by_user_id BIGINT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### `user_settings`
```sql
CREATE TABLE user_settings (
  user_id BIGINT PRIMARY KEY,
  username TEXT,
  selected_personality VARCHAR(100) DEFAULT 'neutral',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### `chat_metadata`
```sql
CREATE TABLE chat_metadata (
  chat_id BIGINT PRIMARY KEY,
  chat_title TEXT,
  chat_type TEXT,
  bot_added_at TIMESTAMP DEFAULT NOW(),
  last_activity TIMESTAMP DEFAULT NOW()
);
```

#### `cooldowns`
```sql
CREATE TABLE cooldowns (
  chat_id BIGINT PRIMARY KEY,
  last_summary_at TIMESTAMP,
  last_judge_at TIMESTAMP,
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### `analytics`
```sql
CREATE TABLE analytics (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT,
  chat_id BIGINT,
  event_type VARCHAR(50),
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## üì± –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê

**–í–ê–ñ–ù–û:** –ö–æ–º–∞–Ω–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –õ–ê–¢–ò–ù–°–ö–ò–ï –Ω–∞–∑–≤–∞–Ω–∏—è (Telegram API —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ)

### `/start`
–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### `/help`
–ü–æ–ª–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º

### `/sut [–ø–µ—Ä–∏–æ–¥]`
–°–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞
- –í **–≥—Ä—É–ø–ø–µ**: —Å–∞–º–º–∞—Ä–∏ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
- –í **–õ–°**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞

**–ü—Ä–∏–º–µ—Ä—ã:**
- `/sut` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π
- `/sut 100` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
- `/sut 2h` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —á–∞—Å–∞
- `/sut today` - —Å –Ω–∞—á–∞–ª–∞ –¥–Ω—è

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** HMAC –ø–æ–¥–ø–∏—Å—å, –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–ª–µ–Ω—Å—Ç–≤–∞, rate limiting, cooldown

### `/rassudi <—Ç–µ–∫—Å—Ç>`
–†–∞—Å—Å—É–¥–∏—Ç—å —Å–ø–æ—Ä
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç —É–ø–æ–º—è–Ω—É—Ç—ã—Ö @username
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Ö –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –í—ã–¥–∞—ë—Ç –≤–µ—Ä–¥–∏–∫—Ç –≤ —Å—Ç–∏–ª–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏

### `/lichnost`
–í—ã–±–æ—Ä –ª–∏—á–Ω–æ—Å—Ç–∏ AI
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç 7 –±–∞–∑–æ–≤—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é"

### `/stats`
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∞–º–º–∞—Ä–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–æ—Ä–æ–≤ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–æ

---

## üé≠ –õ–ò–ß–ù–û–°–¢–ò AI (7 –±–∞–∑–æ–≤—ã—Ö)

–í—Å–µ –ª–∏—á–Ω–æ—Å—Ç–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î (`personalities` —Ç–∞–±–ª–∏—Ü–∞):

1. **üéì –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π (neutral)** - –¥–µ—Ñ–æ–ª—Ç, –≤–µ–∂–ª–∏–≤—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π
2. **üè≠ –ë—ã–¥–ª–∞–Ω (bydlan)** - –∑–∞–≤–æ–¥—á–∞–Ω–∏–Ω, –º–∞—Ç—é–∫–∞–µ—Ç—Å—è, –ø—Ä–æ –∞–≤—Ç–æ–º–æ–π–∫—É
3. **üßô –§–∏–ª–æ—Å–æ—Ñ (philosopher)** - –º—É–¥—Ä–µ—Ü, –≥–ª—É–±–æ–∫–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è
4. **üëü –ì–æ–ø–Ω–∏–∫ (gopnik)** - –ø–∞—Ü–∞–Ω –∏–∑ 2000-—Ö, —Å–ª–µ–Ω–≥, –ø–æ–¥—ä–µ–∑–¥
5. **üíº –û–ª–∏–≥–∞—Ä—Ö (oligarch)** - –±–æ–≥–∞—á, —è—Ö—Ç—ã –∏ –º–∏–ª–ª–∏–æ–Ω—ã
6. **üòÇ –°—Ç–µ–Ω–¥–∞–ø–µ—Ä (comedian)** - –∫–æ–º–∏–∫, –≤—Å—ë –≤ —à—É—Ç–∫—É
7. **üî¨ –£—á—ë–Ω—ã–π (scientist)** - –Ω–∞—É—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

**–ö–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–∏ (–¥–æ 5 —à—Ç—É–∫)
- Sanitization –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç prompt injection
- –ó–∞–ø—Ä–µ—â–µ–Ω—ã –∏–º–µ–Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ª—é–¥–µ–π

---

## üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
TELEGRAM_BOT_TOKEN=123456:ABC-DEF...
ANTHROPIC_API_KEY=sk-ant-...
ANTHROPIC_MODEL=claude-3-7-sonnet-20250219
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_KEY=eyJhbGci...

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
SECRET_KEY=random_secret_for_hmac_12345

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
MESSAGE_RETENTION_DAYS=2                    # –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
DEFAULT_SUMMARY_HOURS=24
DEFAULT_PERSONALITY=neutral
COOLDOWN_SECONDS=60
RATE_LIMIT_REQUESTS=10
RATE_LIMIT_WINDOW=60
MAX_MESSAGES_PER_SUMMARY=500
DEFAULT_MESSAGE_LIMIT=50
MAX_CUSTOM_PERSONALITIES_PER_USER=5
MAX_PERSONALITY_DESCRIPTION_LENGTH=500
MIN_PERSONALITY_DESCRIPTION_LENGTH=10
LOG_LEVEL=INFO
```

### –í–∞–∂–Ω–æ –¥–ª—è Vercel

**Environment Variables** –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ Vercel Dashboard:
- Settings ‚Üí Environment Variables
- –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Production, Preview, Development
- –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–¥–µ–ª–∞—Ç—å redeploy

---

## üîÑ –ê–í–¢–û–£–î–ê–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô

**–ú–µ—Ö–∞–Ω–∏–∑–º:**
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –≤ —á–∞—Ç–µ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ `MESSAGE_RETENTION_DAYS` (2 –¥–Ω—è)
- –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞ (–Ω–µ –≥–ª–æ–±–∞–ª—å–Ω–æ)
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `services/db_service.py:46-57`

**Cleanup —Å–∫—Ä–∏–ø—Ç:** `scripts/cleanup_old_messages.py`
- –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–Ω–µ –Ω–∞ Vercel!)
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ `README_CLEANUP.md`

---

## üöÄ DEPLOYMENT

### Vercel Setup

```bash
# Deploy
vercel deploy --prod

# Set environment variables —á–µ—Ä–µ–∑ Dashboard:
# Settings ‚Üí Environment Variables

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook
curl "https://api.telegram.org/bot<TOKEN>/setWebhook?url=https://vkratse.vercel.app"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook
curl "https://api.telegram.org/bot<TOKEN>/getWebhookInfo"
```

### Deployment Checklist

**–ü–µ—Ä–µ–¥ deployment:**
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] –ö–æ–º–∞–Ω–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç Latin –Ω–∞–∑–≤–∞–Ω–∏—è
- [ ] Application.initialize() –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- [ ] Pure WSGI –±–µ–∑ Werkzeug
- [ ] Environment variables —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ Vercel

**–ü–æ—Å–ª–µ deployment:**
- [ ] –õ–æ–≥–∏ Vercel –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç 200 OK
- [ ] Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ production URL
- [ ] getWebhookInfo –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–æ–∫
- [ ] –ö–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç: /start, /help, /sut

---

## üéØ –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

**Production bot:** @chto_bilo_v_chate_bot
**URL:** https://vkratse.vercel.app
**Deployment:** Vercel Serverless
**Database:** Supabase PostgreSQL

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏—á–∏:**
- ‚úÖ Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –í—Å–µ –∫–æ–º–∞–Ω–¥—ã: /start, /help, /sut, /rassudi, /lichnost, /stats
- ‚úÖ –°–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –≤ –≥—Ä—É–ø–ø–∞—Ö –∏ –õ–° (—Å –≤—ã–±–æ—Ä–æ–º —á–∞—Ç–∞)
- ‚úÖ 7 –±–∞–∑–æ–≤—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π (—á–µ—Ä–µ–∑ ConversationHandler)
- ‚úÖ –°—É–¥–µ–π—Å—Ç–≤–æ —Å–ø–æ—Ä–æ–≤
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã (/sut 2h, /sut today)
- ‚úÖ –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (2 –¥–Ω—è)
- ‚úÖ Rate limiting –∏ cooldown
- ‚úÖ HMAC –∑–∞—â–∏—Ç–∞ callback_data
- ‚úÖ Sanitization –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π
- ‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (—Ç–∞–±–ª–∏—Ü–∞ analytics)
- ‚úÖ User data persistence
- ‚úÖ Cleanup —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏

### üî® –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ / TODO

- [ ] –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Tribute (–ü–û–°–õ–ï —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- [ ] –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- [ ] –≠–∫—Å–ø–æ—Ä—Ç —Å–∞–º–º–∞—Ä–∏ –≤ —Ñ–∞–π–ª—ã
- [ ] Scheduled summaries (–∫—Ä–æ–Ω-–∑–∞–¥–∞—á–∏)
- [ ] Premium —Ñ—É–Ω–∫—Ü–∏–∏

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –≥—Ä—É–ø–ø—É —Å –¥—Ä—É–∑—å—è–º–∏
2. –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞
3. –ù–∞–ø–∏—Å–∞—Ç—å 50+ —Å–æ–æ–±—â–µ–Ω–∏–π
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã:
   - [ ] /start –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
   - [ ] /help –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É
   - [ ] /sut –≤ –≥—Ä—É–ø–ø–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - [ ] /sut –≤ –õ–° –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ —á–∞—Ç–æ–≤
   - [ ] –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ ‚Üí —Å–∞–º–º–∞—Ä–∏ –≤ –õ–°
   - [ ] /rassudi –≤—ã–¥–∞—ë—Ç –≤–µ—Ä–¥–∏–∫—Ç
   - [ ] /lichnost –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–∏—á–Ω–æ—Å—Ç–∏
   - [ ] –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - [ ] /stats –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ (–ø–æ–¥–æ–∂–¥–∞—Ç—å 2 –¥–Ω—è)
6. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞—Å–ø–∞–º–∏—Ç—å (cooldown –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–±–æ—Ç–∞—Ç—å)
7. –£–¥–∞–ª–∏—Ç—å –±–æ—Ç–∞ (–¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –æ—á–∏—Å—Ç–∏—Ç—å—Å—è)

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- [ ] HMAC –ø–æ–¥–ø–∏—Å–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è
- [ ] –ù–µ–ª—å–∑—è –ø–æ–ª—É—á–∏—Ç—å —Å–∞–º–º–∞—Ä–∏ —á–∞—Ç–∞ –≥–¥–µ –Ω–µ —Å–æ—Å—Ç–æ–∏—à—å
- [ ] Rate limiting –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–ø–∞–º
- [ ] Cooldown –±–ª–æ–∫–∏—Ä—É–µ—Ç —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —á–∞—Ç–µ
- [ ] Sanitization –±–ª–æ–∫–∏—Ä—É–µ—Ç prompt injection
- [ ] –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å —Å –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏

---

## üí° –ö–õ–Æ–ß–ï–í–´–ï –ú–û–ú–ï–ù–¢–´ –î–õ–Ø CLAUDE

### –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∫–æ–¥–æ–º:

1. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –∫–∞–∂–¥–∞—è —Ñ–∏—á–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –º–æ–¥—É–ª–µ
2. **–¢–∏–ø–∏–∑–∞—Ü–∏—è** - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å type hints
3. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏** - docstrings –≤–µ–∑–¥–µ
4. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** - –≤—Å—ë —á–µ—Ä–µ–∑ config.py
5. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –≤—Å–µ–≥–¥–∞ sanitize –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥
6. **–ü—Ä–æ–≤–µ—Ä–∫–∏** - –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —á–ª–µ–Ω—Å—Ç–≤–æ –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç—É–ø–æ–º –∫ –¥–∞–Ω–Ω—ã–º
7. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
8. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - try/except –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API

### –í–∞–∂–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

- –ö–æ–º–∞–Ω–¥—ã —Ç–æ–ª—å–∫–æ –Ω–∞ LATIN (Telegram API requirement)
- Pure WSGI (–±–µ–∑ Werkzeug –¥–ª—è Vercel)
- Application.initialize() –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- Graceful degradation –¥–ª—è –∏–º–ø–æ—Ä—Ç–æ–≤
- HMAC –¥–ª—è callback_data –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- Rate limiting –∏ cooldown –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∞–±—É–∑–∞

---

## üìö –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

- **README.md** - –æ—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
- **README_CLEANUP.md** - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ cleanup —Å–∫—Ä–∏–ø—Ç—É
- **CLAUDE.md** - —ç—Ç–æ—Ç —Ñ–∞–π–ª, –¥–ª—è Claude Code
- **sql/*.sql** - SQL —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ë–î

---

## üêõ –ò–ó–í–ï–°–¢–ù–´–ï –û–°–û–ë–ï–ù–ù–û–°–¢–ò

### Vercel Serverless Limitations

1. **No background tasks** - –Ω–µ–ª—å–∑—è –∑–∞–ø—É—Å–∫–∞—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
2. **Stateless** - –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ–∑–∞–≤–∏—Å–∏–º
3. **Timeout** - –º–∞–∫—Å–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–ø—Ä–æ—Å
4. **No cron jobs** - –¥–ª—è scheduled tasks –Ω—É–∂–µ–Ω –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å

### –†–µ—à–µ–Ω–∏—è:

- **–ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ** - –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
- **Cleanup —Å–∫—Ä–∏–ø—Ç** - –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ
- **User data** - —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ bot_data —á–µ—Ä–µ–∑ persistence
- **Cooldown** - in-memory, –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –±–ª–∞–≥–æ–¥–∞—Ä—è bot_data

---

## üîó –ü–û–õ–ï–ó–ù–´–ï –°–°–´–õ–ö–ò

- [python-telegram-bot docs](https://docs.python-telegram-bot.org/)
- [Anthropic Claude API](https://docs.anthropic.com/)
- [Supabase docs](https://supabase.com/docs)
- [Vercel Python runtime](https://vercel.com/docs/runtimes#official-runtimes/python)

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-11-14
**–í–µ—Ä—Å–∏—è –±–æ—Ç–∞:** Production
**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
