# üí∞ TODO: –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è v2.1

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-17
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-11-17 (–®–∞–≥ 11 –∑–∞–≤–µ—Ä—à–µ–Ω)
**–°—Ç–∞—Ç—É—Å:** –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
**–ü—Ä–æ–≥—Ä–µ—Å—Å:** 63/75 –∑–∞–¥–∞—á (84%)

**üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
- [QUICKSTART_MONETIZATION.md](./QUICKSTART_MONETIZATION.md) - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –∑–∞ 5 –º–∏–Ω—É—Ç
- [TESTING_MONETIZATION.md](./TESTING_MONETIZATION.md) - –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
- [TESTING_TELEGRAM_STARS.md](./TESTING_TELEGRAM_STARS.md) - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram Stars (–®–∞–≥ 11)

---

## üìä –ú–æ–¥–µ–ª—å –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ (–∫—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞)

| –§—É–Ω–∫—Ü–∏—è | Free | Free + Group | Pro | Pro + Group |
| :--- | :--- | :--- | :--- | :--- |
| –õ–° —Å–æ–æ–±—â–µ–Ω–∏—è | 30/–¥–µ–Ω—å | 30/–¥–µ–Ω—å | 500/–¥–µ–Ω—å | 500/–¥–µ–Ω—å |
| Summary –≤ –õ–° | 3/–¥–µ–Ω—å | 3/–¥–µ–Ω—å | 10/–¥–µ–Ω—å | 10/–¥–µ–Ω—å |
| Summary –≤ –≥—Ä—É–ø–ø–∞—Ö | 3/–¥–µ–Ω—å | 3/–¥–µ–Ω—å | 20/–¥–µ–Ω—å | 20/–¥–µ–Ω—å |
| –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π | ‚ôæÔ∏è | ‚ôæÔ∏è | ‚ôæÔ∏è | ‚ôæÔ∏è |
| **–û—Å—Ç–∞–ª—å–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏** | 5 summary<br>5 chat<br>5 rassudi | 5 summary<br>5 chat<br>5 rassudi | **–ë–µ–∑ –ª–∏–º–∏—Ç–æ–≤ (‚ôæÔ∏è)** | **–ë–µ–∑ –ª–∏–º–∏—Ç–æ–≤ (‚ôæÔ∏è)** |
| –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏ | 0 | 1 (–±–æ–Ω—É—Å) | 3 | 4 (3+1) |
| –û–±—â–∏–π –ª–∏–º–∏—Ç /rassudi | 2/–¥–µ–Ω—å | 2/–¥–µ–Ω—å | 20/–¥–µ–Ω—å | 20/–¥–µ–Ω—å |
| Cooldown | 60 —Å–µ–∫ | 60 —Å–µ–∫ | 30 —Å–µ–∫ | 30 —Å–µ–∫ |
| –ö–æ–Ω—Ç–µ–∫—Å—Ç | 30 —Å–æ–æ–±—â–µ–Ω–∏–π | 30 —Å–æ–æ–±—â–µ–Ω–∏–π | 50 —Å–æ–æ–±—â–µ–Ω–∏–π | 50 —Å–æ–æ–±—â–µ–Ω–∏–π |

---

## üéØ –≠–¢–ê–ü 1: –ë–ê–ó–û–í–ê–Ø –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–ê (25 –∑–∞–¥–∞—á)

### –®–∞–≥ 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î –¥–ª—è –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏

- [x] **1.1** –°–æ–∑–¥–∞—Ç—å SQL-–º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `subscriptions`
  ```sql
  CREATE TABLE subscriptions (
    id SERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL UNIQUE,
    tier VARCHAR(20) NOT NULL,  -- 'free', 'pro'
    started_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP,  -- NULL –¥–ª—è free tier
    payment_method VARCHAR(50),  -- 'stars', 'yookassa', 'tribute'
    transaction_id VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
  );
  ```

- [x] **1.2** –°–æ–∑–¥–∞—Ç—å SQL-–º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `usage_limits`
  ```sql
  CREATE TABLE usage_limits (
    id SERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    date DATE DEFAULT CURRENT_DATE,
    messages_count INT DEFAULT 0,
    summaries_count INT DEFAULT 0,
    summaries_dm_count INT DEFAULT 0,
    judge_count INT DEFAULT 0,
    UNIQUE(user_id, date)
  );
  ```

- [x] **1.3** –°–æ–∑–¥–∞—Ç—å SQL-–º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `personality_usage`
  ```sql
  CREATE TABLE personality_usage (
    id SERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    personality_name VARCHAR(100) NOT NULL,
    date DATE DEFAULT CURRENT_DATE,
    summary_count INT DEFAULT 0,
    chat_count INT DEFAULT 0,
    judge_count INT DEFAULT 0,
    UNIQUE(user_id, personality_name, date)
  );
  ```

- [x] **1.4** –°–æ–∑–¥–∞—Ç—å SQL-–º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `group_membership_cache`
  ```sql
  CREATE TABLE group_membership_cache (
    user_id BIGINT PRIMARY KEY,
    is_member BOOLEAN DEFAULT FALSE,
    checked_at TIMESTAMP DEFAULT NOW()
  );
  ```

- [x] **1.5** –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `is_group_bonus` –≤ —Ç–∞–±–ª–∏—Ü—É `personalities`
  ```sql
  ALTER TABLE personalities ADD COLUMN is_group_bonus BOOLEAN DEFAULT FALSE;
  ```

- [x] **1.6** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Supabase (—Å–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ sql/migrations/README_MONETIZATION_MIGRATIONS.md)

- [x] **1.7** –û–±–Ω–æ–≤–∏—Ç—å `config.py`: –¥–æ–±–∞–≤–∏—Ç—å `PROJECT_TELEGRAM_GROUP_ID`
  ```python
  PROJECT_TELEGRAM_GROUP_ID = int(os.getenv('PROJECT_TELEGRAM_GROUP_ID', '0'))
  ```

- [x] **1.8** –û–±–Ω–æ–≤–∏—Ç—å `config.py`: –¥–æ–±–∞–≤–∏—Ç—å `TIER_LIMITS`
  ```python
  TIER_LIMITS = {
      'free': {
          'messages_dm': 30,
          'summaries_dm': 3,
          'summaries_group': 3,
          'judge': 2,
          'personality_summary': 5,
          'personality_chat': 5,
          'personality_judge': 5,
          'custom_personalities': 0,
          'context_messages': 30,
          'cooldown_seconds': 60
      },
      'pro': {
          'messages_dm': 500,
          'summaries_dm': 10,
          'summaries_group': 20,
          'judge': 20,
          # –í–ê–ñ–ù–û: Pro-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–º–µ—é—Ç –±–µ–∑–ª–∏–º–∏—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–µ–π
          # personality_summary, personality_chat, personality_judge –ù–ï —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
          'custom_personalities': 3,
          'context_messages': 50,
          'cooldown_seconds': 30
      }
  }
  ```

- [ ] **1.9 –¢–ï–°–¢:** –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

### –®–∞–≥ 2: –°–µ—Ä–≤–∏—Å—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

- [x] **2.1** –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `services/subscription.py`

- [x] **2.2** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `get_user_tier(user_id: int) -> str`
  ```python
  async def get_user_tier(user_id: int) -> str:
      """
      –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: 'free' –∏–ª–∏ 'pro'
      –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç expires_at –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–∞—É–Ω–≥—Ä–µ–π–¥–∞
      """
      subscription = await db_service.get_subscription(user_id)

      if not subscription or not subscription.is_active:
          return 'free'

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è Vercel)
      if subscription.expires_at and subscription.expires_at < datetime.now():
          await auto_downgrade_expired_subscription(user_id)
          return 'free'

      return subscription.tier
  ```

- [x] **2.3** –î–æ–±–∞–≤–∏—Ç—å –≤ `db_service.py`: `get_subscription(user_id: int)`

- [x] **2.4** –î–æ–±–∞–≤–∏—Ç—å –≤ `db_service.py`: –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
  - `get_subscription(user_id)`
  - `create_or_update_subscription(...)`
  - `deactivate_subscription(user_id)`
  - `get_usage_limits(user_id, date)`
  - `increment_usage_limit(user_id, action)`
  - `get_personality_usage(user_id, personality, date)`
  - `increment_personality_usage(user_id, personality, action)`
  - `get_group_membership_cache(user_id)`
  - `update_group_membership_cache(user_id, is_member)`
  - `get_active_custom_personalities_count(user_id)`
  - `block_excess_custom_personalities(user_id, limit)`

- [x] **2.5** –û–±–Ω–æ–≤–∏—Ç—å `services/subscription.py`: –¥–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é db_service

- [ ] **2.6 –¢–ï–°–¢:** –í—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–∏—Ç—å Pro-–ø–æ–¥–ø–∏—Å–∫—É –≤ –ë–î –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `get_user_tier()`
  - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É —Å `is_active=True` ‚Üí –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å 'pro'
  - –ò–∑–º–µ–Ω–∏—Ç—å `is_active=False` ‚Üí –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å 'free'
  - –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å ‚Üí –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å 'free'
  - **–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** [TESTING_MONETIZATION.md](./TESTING_MONETIZATION.md)

---

### –®–∞–≥ 3: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤—ã—Ö –ª–∏–º–∏—Ç–æ–≤ (–¥–ª—è Free-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

**–¶–µ–ª—å:** –í–Ω–µ–¥—Ä–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è Free-—Ç–∞—Ä–∏—Ñ–∞

- [x] **3.1** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `check_usage_limit(user_id: int, action: str) -> dict` ‚úÖ
  ```python
  async def check_usage_limit(user_id: int, action: str) -> dict:
      """
      –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è

      Args:
          user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          action: 'message_dm', 'summary_dm', 'summary_group', 'judge'

      Returns:
          {'can_proceed': bool, 'current': int, 'limit': int, 'tier': str}
      """
  ```

- [x] **3.2** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `increment_usage(user_id: int, action: str)` ‚úÖ

- [x] **3.3** –î–æ–±–∞–≤–∏—Ç—å –≤ `db_service.py`: `get_usage_limits(user_id: int, date: date)` ‚úÖ

- [x] **3.4** –î–æ–±–∞–≤–∏—Ç—å –≤ `db_service.py`: `increment_usage_limit(user_id: int, action: str)` ‚úÖ

- [x] **3.5** –í—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ `modules/direct_chat.py:handle_direct_message()` ‚úÖ
  ```python
  # –í –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
  limit_check = await check_usage_limit(user_id, 'message_dm')
  if not limit_check['can_proceed']:
      await update.message.reply_text(
          f"‚ö†Ô∏è –õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å—á–µ—Ä–ø–∞–Ω ({limit_check['current']}/{limit_check['limit']}).\n"
          f"–û–±–Ω–æ–≤–∏—Ç–µ —Ç–∞—Ä–∏—Ñ: /premium"
      )
      return

  # –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
  await increment_usage(user_id, 'message_dm')
  ```

- [x] **3.6** –í—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ `modules/summaries.py` (–¥–ª—è –õ–° summary –∏ –≥—Ä—É–ø–ø–æ–≤—ã—Ö summary) ‚úÖ
  ```python
  # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç: –õ–° –∏–ª–∏ –≥—Ä—É–ø–ø–∞
  action = 'summary_dm' if chat_type == ChatType.PRIVATE else 'summary_group'
  limit_check = await check_usage_limit(user_id, action)
  ```

- [x] **3.7** –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `show_upgrade_message(update, reason: str)` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ `utils/upgrade_messages.py`
  ```python
  async def show_upgrade_message(update: Update, reason: str):
      """–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º —É–ª—É—á—à–∏—Ç—å —Ç–∞—Ä–∏—Ñ"""
      message = f"‚ö†Ô∏è {reason}\n\n"
      message += "üíé –û–±–Ω–æ–≤–∏—Ç–µ –¥–æ Pro:\n"
      message += "‚Ä¢ –î–æ 500 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å\n"
      message += "‚Ä¢ –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏\n"
      message += "‚Ä¢ –ò –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ!\n\n"
      message += "–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ: /premium"
  ```

- [x] **3.8** –í—Å—Ç—Ä–æ–∏—Ç—å `show_upgrade_message()` –≤–æ –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å –ª–∏–º–∏—Ç–∞–º–∏ ‚úÖ
  - ‚úÖ `modules/direct_chat.py` - –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
  - ‚úÖ `modules/summaries.py` - –ª–∏–º–∏—Ç—ã —Å–∞–º–º–∞—Ä–∏ (DM + –≥—Ä—É–ø–ø—ã)
  - ‚úÖ `modules/judge.py` - –ª–∏–º–∏—Ç —Å—É–¥–µ–π—Å—Ç–≤–∞

- [ ] **3.9 –¢–ï–°–¢:** –û—Ç–ø—Ä–∞–≤–∏—Ç—å 30 —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç—É –≤ –õ–°
  - 30-–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏
  - 31-–µ –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ª–∏–º–∏—Ç–µ
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î: `messages_count = 30`

- [ ] **3.10 –¢–ï–°–¢:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `/summary` –≤ –õ–° 3 —Ä–∞–∑–∞
  - 3-–π —Ä–∞–∑ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
  - 4-–π —Ä–∞–∑ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ª–∏–º–∏—Ç–µ
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î: `summaries_dm_count = 3`

---

## üéØ –≠–¢–ê–ü 2: –í–ù–ï–î–†–ï–ù–ò–ï PRO-–ü–û–î–ü–ò–°–ö–ò (22 –∑–∞–¥–∞—á–∏)

### –®–∞–≥ 4: –ö–æ–º–∞–Ω–¥—ã /premium –∏ /mystatus

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –ø–æ–∫—É–ø–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤

- [ ] **4.1** –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã `/premium` –≤ `modules/commands.py`
  ```python
  async def premium_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
      """–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã"""
      user_id = update.effective_user.id
      current_tier = await get_user_tier(user_id)

      message = "üíé Premium –ø–ª–∞–Ω—ã\n\n"
      message += "üÜì FREE (—Ç–µ–∫—É—â–∏–π –ø–ª–∞–Ω)\n" if current_tier == 'free' else "üÜì FREE\n"
      message += "‚Ä¢ 30 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å\n"
      message += "‚Ä¢ 3 —Å–∞–º–º–∞—Ä–∏ –≤ –õ–°/–¥–µ–Ω—å\n"
      message += "‚Ä¢ 5 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –ª–∏—á–Ω–æ—Å—Ç–∏/–¥–µ–Ω—å\n\n"

      message += "‚≠ê PRO - $2.99/–º–µ—Å\n" if current_tier != 'pro' else "‚≠ê PRO (—Ç–µ–∫—É—â–∏–π –ø–ª–∞–Ω)\n"
      message += "‚Ä¢ 500 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å\n"
      message += "‚Ä¢ –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏ ‚ôæÔ∏è\n"
      message += "‚Ä¢ 3 –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏\n"
      message += "‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞\n\n"

      keyboard = [
          [InlineKeyboardButton("üí≥ –ö—É–ø–∏—Ç—å Pro", callback_data=sign_callback_data("buy_pro"))],
          [InlineKeyboardButton("üéÅ Tribute.to", url=config.TRIBUTE_URL)],
          [InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data=sign_callback_data("back_to_start"))]
      ]
      reply_markup = InlineKeyboardMarkup(keyboard)
      await update.message.reply_text(message, reply_markup=reply_markup)
  ```

- [ ] **4.2** –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "üíé Premium" –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é `/start`
  ```python
  # –í —Ñ—É–Ω–∫—Ü–∏–∏ start_command –∏ show_main_menu
  if chat_type == ChatType.PRIVATE:
      keyboard = [
          [InlineKeyboardButton("üí¨ –û–±—â–∞—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É—é", callback_data=sign_callback_data("direct_chat"))],
          [InlineKeyboardButton("üìä –°–∞–º–º–∞—Ä–∏ –≥—Ä—É–ø–ø", callback_data=sign_callback_data("dm_summary"))],
          [InlineKeyboardButton("üíé Premium", callback_data=sign_callback_data("show_premium"))],  # –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê
          [InlineKeyboardButton("üë• –î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç", url=f"https://t.me/{config.BOT_USERNAME}?startgroup=true")],
          [InlineKeyboardButton("üé≠ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å", callback_data=sign_callback_data("setup_personality"))]
      ]
  ```

- [ ] **4.3** –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ callback_query –¥–ª—è –∫–Ω–æ–ø–∫–∏ Premium
  ```python
  async def handle_show_premium_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
      """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ Premium –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é"""
      query = update.callback_query
      await query.answer()

      # –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –∏–∑ premium_command
      # –ù–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å edit_message_text –≤–º–µ—Å—Ç–æ reply_text
  ```

- [ ] **4.4** –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã `/mystatus` –≤ `modules/commands.py`
  ```python
  async def mystatus_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
      """–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
      user_id = update.effective_user.id
      tier = await get_user_tier(user_id)
      usage = await get_usage_limits(user_id, date.today())

      # –≠–º–æ–¥–∑–∏ –¥–ª—è —Ç–∞—Ä–∏—Ñ–∞
      tier_emoji = "üíé" if tier == 'pro' else "üÜì"
      tier_name = "Pro" if tier == 'pro' else "Free"

      message = f"üìä –¢–≤–æ–π —Å—Ç–∞—Ç—É—Å\n\n"
      message += f"–¢–∞—Ä–∏—Ñ: {tier_emoji} {tier_name}\n"

      # –ï—Å–ª–∏ Pro - –ø–æ–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É –∏—Å—Ç–µ—á–µ–Ω–∏—è
      if tier == 'pro':
          subscription = await get_subscription(user_id)
          if subscription.expires_at:
              days_left = (subscription.expires_at - datetime.now()).days
              message += f"–ê–∫—Ç–∏–≤–µ–Ω –¥–æ: {subscription.expires_at.strftime('%Y-%m-%d')}\n"
              message += f"–û—Å—Ç–∞–ª–æ—Å—å: {days_left} –¥–Ω–µ–π\n\n"

      # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è
      limits = TIER_LIMITS[tier]
      message += "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è:\n"
      message += f"üí¨ –°–æ–æ–±—â–µ–Ω–∏—è: {usage.messages_count}/{limits['messages_dm']}\n"
      message += f"üìù –°–∞–º–º–∞—Ä–∏ (–õ–°): {usage.summaries_dm_count}/{limits['summaries_dm']}\n"
      message += f"‚öñÔ∏è –°—É–¥–µ–π—Å—Ç–≤–æ: {usage.judge_count}/{limits['judge']}\n\n"

      if tier == 'free':
          message += "üí° –û–±–Ω–æ–≤–∏—Å—å –¥–æ Pro: /premium"

      await update.message.reply_text(message)
  ```

- [ ] **4.5 –¢–ï–°–¢:** –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/premium` –∏ —É–≤–∏–¥–µ—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ –≤—ã–¥–µ–ª–µ–Ω
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

- [ ] **4.6 –¢–ï–°–¢:** –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/mystatus` –∏ —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å
  - –î–ª—è Free: –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å "üÜì Free" –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å—á–µ—Ç—á–∏–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

---

### –®–∞–≥ 5: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Tribute.to (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Å–ø–æ—Å–æ–± –ø–æ–∫—É–ø–∫–∏ Pro —á–µ—Ä–µ–∑ –¥–æ–Ω–∞—Ç—ã

- [ ] **5.1** –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ [Tribute.to](https://tribute.to) –¥–ª—è —Å–±–æ—Ä–∞ –¥–æ–Ω–∞—Ç–æ–≤
  - –û–ø–∏—Å–∞—Ç—å —Ç–∞—Ä–∏—Ñ—ã –∏ –±–æ–Ω—É—Å—ã
  - –£–∫–∞–∑–∞—Ç—å, —á—Ç–æ –ø–æ—Å–ª–µ –¥–æ–Ω–∞—Ç–∞ –Ω—É–∂–Ω–æ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–æ–º
  - **–ü–†–ò–ú–ï–ß–ê–ù–ò–ï:** –≠—Ç–æ —Ä—É—á–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–æ—Ç–∞

- [x] **5.2** –î–æ–±–∞–≤–∏—Ç—å –≤ `config.py`: `TRIBUTE_URL` ‚úÖ
  ```python
  TRIBUTE_URL = os.getenv('TRIBUTE_URL', 'https://tribute.to/your_bot_page')
  ADMIN_USER_ID = int(os.getenv('ADMIN_USER_ID', '0'))  # –í–∞—à Telegram ID
  ```
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ config.py:102-103

- [x] **5.3** –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ö—É–ø–∏—Ç—å Pro" –≤ `/premium` ‚úÖ
  ```python
  keyboard = [
      [InlineKeyboardButton("üéÅ Donate (Tribute.to)", url=config.TRIBUTE_URL)],
      [InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data=sign_callback_data("back_to_start"))]
  ]
  ```

- [x] **5.4** –°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω—Å–∫—É—é –∫–æ–º–∞–Ω–¥—É `/grantpro` –≤ `modules/commands.py` ‚úÖ
  - **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:** modules/commands.py:535-666
  - **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ:** api/index.py:93, 277
  - **–£–õ–£–ß–®–ï–ù–ò–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:**
    - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ ADMIN_USER_ID (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å)
    - ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (user_id > 0, days 1-3650)
    - ‚úÖ –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–¥–æ, –≤–æ –≤—Ä–µ–º—è, –ø–æ—Å–ª–µ)
    - ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ —Å graceful degradation
    - ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π transaction_id –¥–ª—è –∞—É–¥–∏—Ç–∞
    - ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ—É–¥–∞—á–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

  **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
  ```bash
  /grantpro <user_id> <days>
  # –ü—Ä–∏–º–µ—Ä—ã:
  /grantpro 123456789 30    # 30 –¥–Ω–µ–π Pro
  /grantpro 987654321 365   # 1 –≥–æ–¥ Pro
  ```

- [x] **5.5** –î–æ–±–∞–≤–∏—Ç—å –≤ `db_service.py`: `create_or_update_subscription()` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ services/subscription.py
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ SubscriptionService.create_or_update_subscription()

- [ ] **5.6 –¢–ï–°–¢:** –ù–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É –≤ `/premium` –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Tribute.to –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è

- [ ] **5.7 –¢–ï–°–¢:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `/grantpro` –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –∞–∫–∫–∞—É–Ω—Ç–µ
  - –í—ã–ø–æ–ª–Ω–∏—Ç—å `/grantpro <test_user_id> 30`
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î: –ø–æ—è–≤–∏–ª–∞—Å—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
  - –° —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å `/mystatus` ‚Üí –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å "üíé Pro"

---

### –®–∞–≥ 6: –õ–æ–≥–∏–∫–∞ –¥–ª—è Pro-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏) ‚úÖ

**–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—É—é —Ñ–∏—á—É Pro - –±–µ–∑–ª–∏–º–∏—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–µ–π

- [x] **6.1** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `check_personality_limit()` –≤ `subscription.py` ‚úÖ
  ```python
  async def check_personality_limit(
      user_id: int,
      personality: str,
      action: str
  ) -> dict:
      """
      –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏

      Args:
          user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          personality: –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä., 'bydlan')
          action: 'summary', 'chat', 'judge'

      Returns:
          {'can_proceed': bool, 'current': int, 'limit': int, 'tier': str}

      –í–ê–ñ–ù–û: –î–ª—è Pro-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –í–°–ï–ì–î–ê –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç can_proceed=True
      """
      tier = await get_user_tier(user_id)

      # Pro-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: –±–µ–∑–ª–∏–º–∏—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–µ–π
      if tier == 'pro':
          return {
              'can_proceed': True,
              'current': 0,
              'limit': -1,  # -1 –æ–∑–Ω–∞—á–∞–µ—Ç –±–µ–∑–ª–∏–º–∏—Ç
              'tier': 'pro'
          }

      # Free-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤
      # –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
      if personality == 'neutral':
          return {'can_proceed': True, 'current': 0, 'limit': -1, 'tier': 'free'}

      # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
      usage = await get_personality_usage(user_id, personality, date.today())
      limits = TIER_LIMITS['free']

      action_key = f'personality_{action}'  # 'personality_summary', 'personality_chat', etc.
      current = getattr(usage, f'{action}_count', 0)
      limit = limits.get(action_key, 5)

      return {
          'can_proceed': current < limit,
          'current': current,
          'limit': limit,
          'tier': 'free'
      }
  ```

- [x] **6.2** –î–æ–±–∞–≤–∏—Ç—å –≤ `db_service.py`: `get_personality_usage()` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ services/db_service.py:836-868
  ```python
  async def get_personality_usage(
      user_id: int,
      personality: str,
      date: date
  ):
      """–ü–æ–ª—É—á–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏ –∑–∞ –¥–∞—Ç—É"""
      try:
          response = self.client.table('personality_usage')\
              .select('*')\
              .eq('user_id', user_id)\
              .eq('personality_name', personality)\
              .eq('date', date.isoformat())\
              .execute()

          if response.data:
              return response.data[0]
          else:
              # –í–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç —Å –Ω—É–ª—è–º–∏
              return {
                  'summary_count': 0,
                  'chat_count': 0,
                  'judge_count': 0
              }
      except Exception as e:
          logger.error(f"Error getting personality usage: {e}")
          return {'summary_count': 0, 'chat_count': 0, 'judge_count': 0}
  ```

- [x] **6.3** –î–æ–±–∞–≤–∏—Ç—å –≤ `db_service.py`: `increment_personality_usage()` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ services/db_service.py:870-924
  - –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ `get_top_personality_usage()` –¥–ª—è /mystatus
  ```python
  async def increment_personality_usage(
      user_id: int,
      personality: str,
      action: str
  ):
      """–£–≤–µ–ª–∏—á–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª–∏—á–Ω–æ—Å—Ç–∏"""
      try:
          today = date.today()
          action_field = f'{action}_count'  # 'summary_count', 'chat_count', 'judge_count'

          # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
          current = await get_personality_usage(user_id, personality, today)
          new_value = current.get(action_field, 0) + 1

          # Upsert
          self.client.table('personality_usage').upsert({
              'user_id': user_id,
              'personality_name': personality,
              'date': today.isoformat(),
              action_field: new_value
          }).execute()
      except Exception as e:
          logger.error(f"Error incrementing personality usage: {e}")
  ```

- [x] **6.4** –í—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ `modules/summaries.py` –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π —Å–∞–º–º–∞—Ä–∏ ‚úÖ
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ _execute_summary() –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
  - –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  ```python
  # –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ª–∏—á–Ω–æ—Å—Ç–∏, –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
  personality_check = await check_personality_limit(user_id, personality, 'summary')

  if not personality_check['can_proceed']:
      await query.edit_message_text(
          f"‚ö†Ô∏è –õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª–∏—á–Ω–æ—Å—Ç–∏ '{personality}' –∏—Å—á–µ—Ä–ø–∞–Ω "
          f"({personality_check['current']}/{personality_check['limit']}).\n\n"
          f"üíé Pro-–ø–æ–¥–ø–∏—Å–∫–∞ –¥–∞–µ—Ç –±–µ–∑–ª–∏–º–∏—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π!\n"
          f"–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ: /premium"
      )
      return

  # –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  await increment_personality_usage(user_id, personality, 'summary')
  ```

- [x] **6.5** –í—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ `modules/direct_chat.py` (–¥–ª—è —á–∞—Ç–∞) ‚úÖ
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ handle_direct_message() –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –æ—Ç–≤–µ—Ç–∞
  - –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

- [x] **6.6** –í—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ `modules/judge.py` (–¥–ª—è —Å—É–¥–µ–π—Å—Ç–≤–∞) ‚úÖ
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ handle_judge_personality_callback() –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –≤–µ—Ä–¥–∏–∫—Ç–∞
  - –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤–µ—Ä–¥–∏–∫—Ç–∞

- [x] **6.7** –û–±–Ω–æ–≤–∏—Ç—å `/mystatus`: –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ª–∏—á–Ω–æ—Å—Ç–µ–π ‚úÖ
  - –î–ª—è Pro: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–õ–∏—á–Ω–æ—Å—Ç–∏: –ë–µ–∑–ª–∏–º–∏—Ç–Ω–æ ‚ôæÔ∏è"
  - –î–ª—è Free: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ø-3 –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–∏ —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π (summary/chat/judge)
  - –§–æ—Ä–º–∞—Ç: "‚Ä¢ –ë—ã–¥–ª–∞–Ω: 12/15 (üìù5 üí¨4 ‚öñÔ∏è3)"
  ```python
  # –î–ª—è Free-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ø-3 –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–∏
  if tier == 'free':
      personality_usage = await get_top_personality_usage(user_id, date.today(), limit=3)
      if personality_usage:
          message += "\nüìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–µ–π:\n"
          for pu in personality_usage:
              total = pu['summary_count'] + pu['chat_count'] + pu['judge_count']
              message += f"‚Ä¢ {pu['personality_name']}: {total}/15\n"

  # –î–ª—è Pro-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  if tier == 'pro':
      message += "\n‚ú® –õ–∏—á–Ω–æ—Å—Ç–∏: –ë–µ–∑–ª–∏–º–∏—Ç–Ω–æ ‚ôæÔ∏è\n"
  ```

- [x] **6.8 –¢–ï–°–¢:** –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å Pro-–ø–æ–¥–ø–∏—Å–∫—É —Å–µ–±–µ ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å "–ë—ã–¥–ª–∞–Ω" –¥–ª—è summary 6+ —Ä–∞–∑ –ø–æ–¥—Ä—è–¥
  - –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å–ø–µ—à–Ω—ã–º–∏ (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)
  - **–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** [TESTING_MONETIZATION.md](./TESTING_MONETIZATION.md) - –†–∞–∑–¥–µ–ª "–®–∞–≥ 6"

- [x] **6.9 –¢–ï–°–¢:** –û—Ç–∫–ª—é—á–∏—Ç—å Pro-–ø–æ–¥–ø–∏—Å–∫—É (—Å—Ç–∞—Ç—å Free) ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "–ë—ã–¥–ª–∞–Ω" –¥–ª—è summary 5 —Ä–∞–∑
  - –ù–∞ 6-–π —Ä–∞–∑ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ª–∏–º–∏—Ç–µ
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `/mystatus`: –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–µ–π
  - **–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** [TESTING_MONETIZATION.md](./TESTING_MONETIZATION.md) - –†–∞–∑–¥–µ–ª "–®–∞–≥ 6"

---

## üéØ –≠–¢–ê–ü 3: –ë–û–ù–£–° –ó–ê –ì–†–£–ü–ü–£ –ò –ö–ê–°–¢–û–ú–ù–´–ï –õ–ò–ß–ù–û–°–¢–ò (21 –∑–∞–¥–∞—á–∞)

### –®–∞–≥ 7: –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–ª–µ–Ω—Å—Ç–≤–∞ –≤ –≥—Ä—É–ø–ø–µ ‚úÖ

**–¶–µ–ª—å:** –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —á–ª–µ–Ω—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø–µ –ø—Ä–æ–µ–∫—Ç–∞

- [x] **7.1** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `is_in_project_group()` –≤ `subscription.py` ‚úÖ
  ```python
  async def is_in_project_group(
      user_id: int,
      bot: Bot,
      force_check: bool = False
  ) -> bool:
      """
      –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–æ—Å—Ç–æ–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –≥—Ä—É–ø–ø–µ –ø—Ä–æ–µ–∫—Ç–∞

      Args:
          user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          bot: Telegram Bot instance
          force_check: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à)

      Returns:
          bool: True –µ—Å–ª–∏ —Å–æ—Å—Ç–æ–∏—Ç –≤ –≥—Ä—É–ø–ø–µ
      """
      if not config.PROJECT_TELEGRAM_GROUP_ID:
          return False

      # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–µ—à (–µ—Å–ª–∏ –Ω–µ force_check)
      if not force_check:
          cache = await get_group_membership_cache(user_id)
          if cache and (datetime.now() - cache['checked_at']).seconds < 3600:  # 1 —á–∞—Å
              return cache['is_member']

      # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ API
      try:
          member = await bot.get_chat_member(
              chat_id=config.PROJECT_TELEGRAM_GROUP_ID,
              user_id=user_id
          )
          is_member = member.status in ['member', 'administrator', 'creator']

          # –û–±–Ω–æ–≤–∏—Ç—å –∫–µ—à
          await update_group_membership_cache(user_id, is_member)

          return is_member
      except Exception as e:
          logger.error(f"Error checking group membership: {e}")
          return False
  ```

- [x] **7.2** –î–æ–±–∞–≤–∏—Ç—å –≤ `db_service.py`: `get_group_membership_cache()` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ services/db_service.py:982-1002

- [x] **7.3** –î–æ–±–∞–≤–∏—Ç—å –≤ `db_service.py`: `update_group_membership_cache()` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ services/db_service.py:1004-1029

- [x] **7.4** –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `chat_member` –≤ `api/index.py` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ api/index.py:251-295
  - `handle_chat_member_update()` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è/–≤—ã—Ö–æ–¥–∞
  - `ChatMemberHandler` –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ api/index.py:479-482
  ```python
  async def handle_chat_member_update(update: Update, context: ContextTypes.DEFAULT_TYPE):
      """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ —á–∞—Ç–µ"""
      chat_member_update = update.chat_member

      # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —ç—Ç–æ –Ω–∞—à–∞ —Ü–µ–ª–µ–≤–∞—è –≥—Ä—É–ø–ø–∞?
      if chat_member_update.chat.id != config.PROJECT_TELEGRAM_GROUP_ID:
          return

      user_id = chat_member_update.new_chat_member.user.id
      old_status = chat_member_update.old_chat_member.status
      new_status = chat_member_update.new_chat_member.status

      # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å: –≤—Å—Ç—É–ø–∏–ª –∏–ª–∏ –≤—ã—à–µ–ª
      was_member = old_status in ['member', 'administrator', 'creator']
      is_member = new_status in ['member', 'administrator', 'creator']

      if was_member != is_member:
          await handle_group_membership_change(user_id, is_member, context.bot)
  ```

- [x] **7.5** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `handle_group_membership_change()` –≤ `subscription.py` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ services/subscription.py:454-510
  - –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–µ—à, –±–ª–æ–∫–∏—Ä—É–µ—Ç/—Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –±–æ–Ω—É—Å–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏
  - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã –≤ db_service.py:
    - `block_group_bonus_personalities()` (1105-1129)
    - `unblock_group_bonus_personalities()` (1131-1155)
  ```python
  async def handle_group_membership_change(
      user_id: int,
      is_member: bool,
      bot: Bot
  ):
      """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ —á–ª–µ–Ω—Å—Ç–≤–∞ –≤ –≥—Ä—É–ø–ø–µ"""
      # –û–±–Ω–æ–≤–∏—Ç—å –∫–µ—à
      await update_group_membership_cache(user_id, is_member)

      # –ï—Å–ª–∏ –≤—ã—à–µ–ª –∏–∑ –≥—Ä—É–ø–ø—ã - –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ–Ω—É—Å–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏ (—Ä–µ–∞–ª–∏–∑—É–µ–º –≤ –®–∞–≥–µ 9)
      if not is_member:
          await block_group_bonus_personalities(user_id)
      else:
          await unblock_group_bonus_personalities(user_id)
  ```

- [ ] **7.6 –¢–ï–°–¢:** –í—Å—Ç—É–ø–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É –ø—Ä–æ–µ–∫—Ç–∞ ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î: `group_membership_cache.is_member = true`
  - –í—ã–∑–≤–∞—Ç—å `is_in_project_group()` ‚Üí –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å `True`
  - **–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** [TESTING_STEP7_GROUP_MEMBERSHIP.md](./TESTING_STEP7_GROUP_MEMBERSHIP.md) - –¢–µ—Å—Ç 1

- [ ] **7.7 –¢–ï–°–¢:** –í—ã–π—Ç–∏ –∏–∑ –≥—Ä—É–ø–ø—ã –ø—Ä–æ–µ–∫—Ç–∞ ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î: `group_membership_cache.is_member = false`
  - –í—ã–∑–≤–∞—Ç—å `is_in_project_group()` ‚Üí –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å `False`
  - **–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** [TESTING_STEP7_GROUP_MEMBERSHIP.md](./TESTING_STEP7_GROUP_MEMBERSHIP.md) - –¢–µ—Å—Ç 4-5

**üìã –í–ê–ñ–ù–û - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –®–∞–≥–∞ 7:**
- –í–∫–ª—é—á–∏—Ç—å `chat_member` –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ BotFather (–≤—ã–∫–ª—é—á–∏—Ç—å Privacy Mode)
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `PROJECT_TELEGRAM_GROUP_ID` –≤ Vercel environment variables
- –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 007 (–ø–æ–ª—è `is_group_bonus` –∏ `is_blocked`)
- **–ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** [TESTING_STEP7_GROUP_MEMBERSHIP.md](./TESTING_STEP7_GROUP_MEMBERSHIP.md)

---

### –®–∞–≥ 8: –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π ‚úÖ

**–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏

- [x] **8.1** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `get_custom_personality_limit()` –≤ `subscription.py` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ services/subscription.py:340-368
  ```python
  async def get_custom_personality_limit(
      user_id: int,
      bot: Bot
  ) -> int:
      """
      –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª–∏–º–∏—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

      Returns:
          int: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π

      –õ–æ–≥–∏–∫–∞:
          Free: 0
          Free + Group: 1
          Pro: 3
          Pro + Group: 4
      """
      tier = await get_user_tier(user_id)
      in_group = await is_in_project_group(user_id, bot)

      if tier == 'pro':
          return 4 if in_group else 3
      else:  # free
          return 1 if in_group else 0
  ```

- [x] **8.2** –î–æ–±–∞–≤–∏—Ç—å –≤ `db_service.py`: `get_active_custom_personalities_count()` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ services/db_service.py:1035-1056
  ```python
  async def get_active_custom_personalities_count(user_id: int) -> int:
      """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
      try:
          response = self.client.table('personalities')\
              .select('id', count='exact')\
              .eq('created_by_user_id', user_id)\
              .eq('is_custom', True)\
              .eq('is_active', True)\
              .execute()

          return response.count if response.count else 0
      except Exception as e:
          logger.error(f"Error counting custom personalities: {e}")
          return 0
  ```

- [x] **8.3** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `can_create_custom_personality()` –≤ `subscription.py` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ services/subscription.py:370-452
  ```python
  async def can_create_custom_personality(
      user_id: int,
      bot: Bot
  ) -> dict:
      """
      –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é –ª–∏—á–Ω–æ—Å—Ç—å

      Returns:
          {
              'can_create': bool,
              'reason': str,
              'current': int,
              'limit': int,
              'needs_group': bool,
              'needs_pro': bool
          }
      """
      tier = await get_user_tier(user_id)
      in_group = await is_in_project_group(user_id, bot)
      limit = await get_custom_personality_limit(user_id, bot)
      current = await get_active_custom_personalities_count(user_id)

      # –°—Ü–µ–Ω–∞—Ä–∏–∏
      if current >= limit:
          if tier == 'free' and not in_group:
              return {
                  'can_create': False,
                  'reason': 'need_group_or_pro',
                  'current': current,
                  'limit': limit,
                  'needs_group': True,
                  'needs_pro': True
              }
          elif tier == 'free' and in_group:
              return {
                  'can_create': False,
                  'reason': 'need_pro',
                  'current': current,
                  'limit': limit,
                  'needs_group': False,
                  'needs_pro': True
              }
          elif tier == 'pro' and not in_group:
              return {
                  'can_create': False,
                  'reason': 'need_group',
                  'current': current,
                  'limit': limit,
                  'needs_group': True,
                  'needs_pro': False
              }
          else:  # pro + group
              return {
                  'can_create': False,
                  'reason': 'max_reached',
                  'current': current,
                  'limit': limit,
                  'needs_group': False,
                  'needs_pro': False
              }

      return {
          'can_create': True,
          'reason': 'ok',
          'current': current,
          'limit': limit,
          'needs_group': False,
          'needs_pro': False
      }
  ```

- [x] **8.4** –û–±–Ω–æ–≤–∏—Ç—å `modules/personalities.py`: –≤—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É ‚úÖ
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ "create_start" (modules/personalities.py:110-141)
  - –£–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑ receive_personality_name (—Å—Ç—Ä–æ–∫–∏ 257-258)
  ```python
  # –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—á–Ω–æ—Å—Ç–∏ (–ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º ConversationHandler)
  async def handle_create_personality_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
      query = update.callback_query
      await query.answer()

      user_id = update.effective_user.id
      check = await can_create_custom_personality(user_id, context.bot)

      if not check['can_create']:
          # –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∏—á–∏–Ω—ã
          if check['reason'] == 'need_group_or_pro':
              message = (
                  f"‚ö†Ô∏è –õ–∏–º–∏—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π: {check['current']}/{check['limit']}\n\n"
                  f"–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ—é –ª–∏—á–Ω–æ—Å—Ç—å:\n"
                  f"‚Ä¢ –í—Å—Ç—É–ø–∏ –≤ –≥—Ä—É–ø–ø—É –ø—Ä–æ–µ–∫—Ç–∞: [—Å—Å—ã–ª–∫–∞]\n"
                  f"–∏–ª–∏\n"
                  f"‚Ä¢ –û–±–Ω–æ–≤–∏—Å—å –¥–æ Pro: /premium"
              )
          elif check['reason'] == 'need_pro':
              message = (
                  f"‚ö†Ô∏è –õ–∏–º–∏—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π: {check['current']}/{check['limit']}\n\n"
                  f"–û–±–Ω–æ–≤–∏—Å—å –¥–æ Pro –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –µ—â–µ 3 –ª–∏—á–Ω–æ—Å—Ç–µ–π: /premium"
              )
          elif check['reason'] == 'need_group':
              message = (
                  f"‚ö†Ô∏è –õ–∏–º–∏—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π: {check['current']}/{check['limit']}\n\n"
                  f"–í—Å—Ç—É–ø–∏ –≤ –≥—Ä—É–ø–ø—É –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è +1 —Å–ª–æ—Ç–∞: [—Å—Å—ã–ª–∫–∞]"
              )
          else:  # max_reached
              message = (
                  f"‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º: {check['current']}/{check['limit']}\n\n"
                  f"–£–¥–∞–ª–∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ /lichnost"
              )

          await query.edit_message_text(message)
          return ConversationHandler.END

      # –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ
      # ...
  ```

- [x] **8.5** –û–±–Ω–æ–≤–∏—Ç—å `db_service.py`: –¥–æ–±–∞–≤–∏—Ç—å `is_group_bonus` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ª–∏—á–Ω–æ—Å—Ç–∏ ‚úÖ
  - –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ create_personality (services/db_service.py:164-206)
  - –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä is_group_bonus (default=False)
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤ personalities.py:342-345 –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∞—Ä–∏—Ñ–∞
  ```python
  async def create_custom_personality(...):
      # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å: —ç—Ç–æ –±–æ–Ω—É—Å–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å –∏–ª–∏ –Ω–µ—Ç
      tier = await get_user_tier(user_id)
      is_group_bonus = (tier == 'free')  # –î–ª—è Free-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —ç—Ç–æ –±–æ–Ω—É—Å –∑–∞ –≥—Ä—É–ø–ø—É

      self.client.table('personalities').insert({
          'name': name,
          'display_name': display_name,
          'system_prompt': system_prompt,
          'is_custom': True,
          'created_by_user_id': user_id,
          'is_group_bonus': is_group_bonus,
          'is_active': True
      }).execute()
  ```

- [ ] **8.6 –¢–ï–°–¢:** Free, –Ω–µ –≤ –≥—Ä—É–ø–ø–µ ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
  - –ù–∞–∂–∞—Ç—å "‚ûï –°–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å"
  - –£–≤–∏–¥–µ—Ç—å: "–í—Å—Ç—É–ø–∏ –≤ –≥—Ä—É–ø–ø—É –∏–ª–∏ –∫—É–ø–∏ Pro"
  - **–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** [TESTING_STEP8_CUSTOM_PERSONALITIES.md](./TESTING_STEP8_CUSTOM_PERSONALITIES.md) - –¢–µ—Å—Ç 1

- [ ] **8.7 –¢–ï–°–¢:** Free, –≤—Å—Ç—É–ø–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
  - –ù–∞–∂–∞—Ç—å "‚ûï –°–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å"
  - –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞—Ç—å 1 –ª–∏—á–Ω–æ—Å—Ç—å
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î: `is_group_bonus = true`
  - –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–æ–∑–¥–∞—Ç—å 2-—é ‚Üí —É–≤–∏–¥–µ—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∫—É–ø–∏—Ç—å Pro
  - **–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** [TESTING_STEP8_CUSTOM_PERSONALITIES.md](./TESTING_STEP8_CUSTOM_PERSONALITIES.md) - –¢–µ—Å—Ç—ã 2-3

- [ ] **8.8 –¢–ï–°–¢:** Pro, –Ω–µ –≤ –≥—Ä—É–ø–ø–µ ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
  - –°–æ–∑–¥–∞—Ç—å 3 –ª–∏—á–Ω–æ—Å—Ç–∏
  - –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–æ–∑–¥–∞—Ç—å 4-—é ‚Üí —É–≤–∏–¥–µ—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤—Å—Ç—É–ø–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É
  - **–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** [TESTING_STEP8_CUSTOM_PERSONALITIES.md](./TESTING_STEP8_CUSTOM_PERSONALITIES.md) - –¢–µ—Å—Ç 4

- [ ] **8.9 –¢–ï–°–¢:** Pro, –≤ –≥—Ä—É–ø–ø–µ ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
  - –°–æ–∑–¥–∞—Ç—å 4 –ª–∏—á–Ω–æ—Å—Ç–∏
  - –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–æ–∑–¥–∞—Ç—å 5-—é ‚Üí —É–≤–∏–¥–µ—Ç—å "–î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º"
  - **–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** [TESTING_STEP8_CUSTOM_PERSONALITIES.md](./TESTING_STEP8_CUSTOM_PERSONALITIES.md) - –¢–µ—Å—Ç 5

- [ ] **8.10 –¢–ï–°–¢:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ/–≤—Ö–æ–¥–µ –≤ –≥—Ä—É–ø–ø—É ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±–æ–Ω—É—Å–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –≥—Ä—É–ø–ø—ã
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
  - **–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** [TESTING_STEP8_CUSTOM_PERSONALITIES.md](./TESTING_STEP8_CUSTOM_PERSONALITIES.md) - –¢–µ—Å—Ç—ã 6-7

**üìã –í–ê–ñ–ù–û - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:**
- –°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: [TESTING_STEP8_CUSTOM_PERSONALITIES.md](./TESTING_STEP8_CUSTOM_PERSONALITIES.md)
- –í–∫–ª—é—á–∞–µ—Ç 7 –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤
- –û–ø–∏—Å–∞–Ω—ã –æ–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Å–ø–æ—Å–æ–±—ã –æ—Ç–ª–∞–¥–∫–∏
- –ì–æ—Ç–æ–≤–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ-–ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–º

---

### –®–∞–≥ 9: –°–æ—Ñ—Ç-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±–æ–Ω—É—Å–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏ ‚úÖ

**–¶–µ–ª—å:** –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ–Ω—É—Å–Ω—É—é –ª–∏—á–Ω–æ—Å—Ç—å –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –≥—Ä—É–ø–ø—ã

- [x] **9.1** –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `is_blocked` –≤ —Ç–∞–±–ª–∏—Ü—É `personalities` (SQL-–º–∏–≥—Ä–∞—Ü–∏—è) ‚úÖ
  - –ú–∏–≥—Ä–∞—Ü–∏—è: `sql/migrations/007_add_personality_bonus_fields.sql`
  - –ü–æ–ª–µ `is_blocked BOOLEAN DEFAULT FALSE` –¥–æ–±–∞–≤–ª–µ–Ω–æ
  - –ò–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–Ω: `idx_personalities_blocked`

- [x] **9.2** –û–±–Ω–æ–≤–∏—Ç—å `handle_group_membership_change()`: –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ª–∏—á–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ services/subscription.py:454-510 (–®–∞–≥ 7)
  - –í—ã–∑—ã–≤–∞–µ—Ç `block_group_bonus_personalities()` –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
  - –í—ã–∑—ã–≤–∞–µ—Ç `unblock_group_bonus_personalities()` –ø—Ä–∏ –≤—Ö–æ–¥–µ
  - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  ```python
  async def handle_group_membership_change(user_id: int, is_member: bool, bot: Bot):
      await update_group_membership_cache(user_id, is_member)

      if not is_member:
          await block_group_bonus_personalities(user_id)

          # –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          try:
              await bot.send_message(
                  chat_id=user_id,
                  text=(
                      "‚ö†Ô∏è –¢—ã –≤—ã—à–µ–ª –∏–∑ –≥—Ä—É–ø–ø—ã –ø—Ä–æ–µ–∫—Ç–∞.\n\n"
                      "–¢–≤–æ—è –±–æ–Ω—É—Å–Ω–∞—è –∫–∞—Å—Ç–æ–º–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞.\n"
                      "–í–µ—Ä–Ω–∏—Å—å –≤ –≥—Ä—É–ø–ø—É, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å: [—Å—Å—ã–ª–∫–∞]"
                  )
              )
          except Exception as e:
              logger.error(f"Failed to notify user {user_id}: {e}")
      else:
          await unblock_group_bonus_personalities(user_id)

          # –£–≤–µ–¥–æ–º–∏—Ç—å –æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
          try:
              await bot.send_message(
                  chat_id=user_id,
                  text=(
                      "üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ!\n\n"
                      "–¢–≤–æ—è –±–æ–Ω—É—Å–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞."
                  )
              )
          except Exception as e:
              logger.error(f"Failed to notify user {user_id}: {e}")
  ```

- [x] **9.3** –î–æ–±–∞–≤–∏—Ç—å –≤ `db_service.py`: `block_group_bonus_personalities()` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ services/db_service.py:1121-1145
  - –ë–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ is_group_bonus –ª–∏—á–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True/False –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏
  - –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

- [x] **9.4** –î–æ–±–∞–≤–∏—Ç—å –≤ `db_service.py`: `unblock_group_bonus_personalities()` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ services/db_service.py:1147-1171
  - –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ is_group_bonus –ª–∏—á–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –°–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å block_group_bonus_personalities()

- [x] **9.5** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `is_blocked` –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ª–∏—á–Ω–æ—Å—Ç–∏ ‚úÖ
  - ‚úÖ models/personality.py - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è is_blocked –∏ is_group_bonus
  - ‚úÖ utils/personality_menu.py - –ø–æ–∫–∞–∑ üîí –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π
  - ‚úÖ modules/personalities.py - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ (pers:blocked handler)
  - ‚úÖ modules/direct_chat.py - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ handle_personality_selection() –∏ handle_direct_message()
  - ‚úÖ modules/summaries.py - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ summary_personality_callback()
  - ‚úÖ modules/judge.py - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ handle_judge_personality_callback()

  **–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
  - –í –º–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –∑–∞–º–∫–æ–º üîí
  - –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—É—é - alert —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
  - –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥—Ä—É–ø–ø—É
  ```python
  # –í utils/personality_menu.py –∏–ª–∏ –≥–¥–µ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –ª–∏—á–Ω–æ—Å—Ç–∏
  async def show_personality_selection(...):
      # –ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –ª–∏—á–Ω–æ—Å—Ç–µ–π
      personalities = await get_user_personalities(user_id)

      for p in personalities:
          if p.is_blocked:
              # –ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –º–µ–Ω—é –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å –∑–∞–º–∫–æ–º
              display_name = f"üîí {p.display_name}"
          else:
              display_name = p.display_name

  # –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ª–∏—á–Ω–æ—Å—Ç—å
  async def handle_personality_selection(...):
      personality = await get_personality(personality_name)

      if personality.is_blocked:
          await query.answer(
              "‚ö†Ô∏è –≠—Ç–∞ –ª–∏—á–Ω–æ—Å—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞. –í–µ—Ä–Ω–∏—Å—å –≤ –≥—Ä—É–ø–ø—É –ø—Ä–æ–µ–∫—Ç–∞!",
              show_alert=True
          )
          return
  ```

- [ ] **9.6 –¢–ï–°–¢:** –°–æ–∑–¥–∞—Ç—å –±–æ–Ω—É—Å–Ω—É—é –ª–∏—á–Ω–æ—Å—Ç—å (Free + –≥—Ä—É–ø–ø–∞) ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
  - –í—ã–π—Ç–∏ –∏–∑ –≥—Ä—É–ø–ø—ã
  - –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –ª–∏—á–Ω–æ—Å—Ç—å
  - –£–≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î: `is_blocked = true`
  - **–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** [TESTING_STEP9_PERSONALITY_BLOCKING.md](./TESTING_STEP9_PERSONALITY_BLOCKING.md) - –¢–µ—Å—Ç—ã 1-4

- [ ] **9.7 –¢–ï–°–¢:** –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥—Ä—É–ø–ø—É ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ª–∏—á–Ω–æ—Å—Ç—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞—Å—å
  - –£—Å–ø–µ—à–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î: `is_blocked = false`
  - **–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** [TESTING_STEP9_PERSONALITY_BLOCKING.md](./TESTING_STEP9_PERSONALITY_BLOCKING.md) - –¢–µ—Å—Ç—ã 5-7

**üìã –í–ê–ñ–ù–û - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:**
- –°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: [TESTING_STEP9_PERSONALITY_BLOCKING.md](./TESTING_STEP9_PERSONALITY_BLOCKING.md)
- –í–∫–ª—é—á–∞–µ—Ç 7 –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤
- –û–ø–∏—Å–∞–Ω—ã –æ–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Å–ø–æ—Å–æ–±—ã –æ—Ç–ª–∞–¥–∫–∏
- –ì–æ—Ç–æ–≤–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ-–ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–º

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ (Vercel limitation)

**–ü—Ä–æ–±–ª–µ–º–∞:** Vercel –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç cron jobs –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—è—Ç—å `expires_at` –ø—Ä–∏ **–∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

- [ ] **CRIT-1** –û–±–Ω–æ–≤–∏—Ç—å `get_user_tier()`: –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `expires_at`
  ```python
  async def get_user_tier(user_id: int) -> str:
      subscription = await get_subscription(user_id)

      if not subscription or not subscription.is_active:
          return 'free'

      # –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
      if subscription.expires_at:
          if subscription.expires_at < datetime.now(timezone.utc):
              logger.info(f"Subscription expired for user {user_id}")
              await auto_downgrade_expired_subscription(user_id)
              return 'free'

      return subscription.tier
  ```

- [ ] **CRIT-2** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `auto_downgrade_expired_subscription()` –≤ `subscription.py`
  ```python
  async def auto_downgrade_expired_subscription(user_id: int):
      """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ Free-—Ç–∞—Ä–∏—Ñ"""
      try:
          # –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
          await deactivate_subscription(user_id)

          # –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ª–∏—à–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏
          # Pro->Free: –æ—Å—Ç–∞–≤–∏—Ç—å 0, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ
          await block_excess_custom_personalities(user_id, limit=0)

          logger.info(f"User {user_id} downgraded to Free (subscription expired)")
      except Exception as e:
          logger.error(f"Error downgrading subscription for {user_id}: {e}")
  ```

- [ ] **CRIT-3** –î–æ–±–∞–≤–∏—Ç—å –≤ `db_service.py`: `deactivate_subscription()`
  ```python
  async def deactivate_subscription(user_id: int):
      """–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
      try:
          self.client.table('subscriptions')\
              .update({'is_active': False, 'updated_at': datetime.now().isoformat()})\
              .eq('user_id', user_id)\
              .execute()
      except Exception as e:
          logger.error(f"Error deactivating subscription: {e}")
  ```

- [ ] **CRIT-4** –í—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –Ω–∞—á–∞–ª–æ –∫–∞–∂–¥–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–æ–º–∞–Ω–¥
  ```python
  # –í –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ command handler
  async def some_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
      user_id = update.effective_user.id

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ get_user_tier)
      tier = await get_user_tier(user_id)

      # –î–∞–ª—å–Ω–µ–π—à–∞—è –ª–æ–≥–∏–∫–∞
      # ...
  ```

- [ ] **CRIT-5** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –¥–∞—É–Ω–≥—Ä–µ–π–¥–µ
  ```python
  # –í auto_downgrade_expired_subscription
  try:
      await context.bot.send_message(
          chat_id=user_id,
          text=(
              "‚è∞ –¢–≤–æ—è Pro-–ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞.\n\n"
              "–¢—ã –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –Ω–∞ Free-—Ç–∞—Ä–∏—Ñ.\n"
              "–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É: /premium"
          )
      )
  except Exception as e:
      logger.error(f"Failed to notify user {user_id} about downgrade: {e}")
  ```

- [ ] **CRIT-6 –¢–ï–°–¢:** –í—Ä—É—á–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `expires_at` –≤ –ø—Ä–æ—à–ª–æ–µ
  - –í—ã–ø–æ–ª–Ω–∏—Ç—å –ª—é–±—É—é –∫–æ–º–∞–Ω–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, `/mystatus`)
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–µ–ª –Ω–∞ Free
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –ø—Ä–∏—à–ª–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–∞—É–Ω–≥—Ä–µ–π–¥–µ
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î: `is_active = false`

---

## üéØ –≠–¢–ê–ü 4: –ó–ê–í–ï–†–®–ï–ù–ò–ï –ò –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø (21 –∑–∞–¥–∞—á–∞)

### –®–∞–≥ 10: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ÆKassa (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2) ‚úÖ

**–¶–µ–ª—å:** –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∫—É Pro —á–µ—Ä–µ–∑ –∫–∞—Ä—Ç—ã –∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏

- [x] **10.1** –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ [–ÆKassa](https://yookassa.ru/), –ø–æ–ª—É—á–∏—Ç—å API-–∫–ª—é—á–∏ ‚úÖ
  - **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** [YOOKASSA_SETUP_GUIDE.md](./YOOKASSA_SETUP_GUIDE.md)
  - –†—É—á–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–æ—Ç–∞

- [x] **10.2** –î–æ–±–∞–≤–∏—Ç—å –≤ `config.py`: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ÆKassa ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ config.py:105-107
  ```python
  YOOKASSA_SHOP_ID = os.getenv('YOOKASSA_SHOP_ID')
  YOOKASSA_SECRET_KEY = os.getenv('YOOKASSA_SECRET_KEY')
  ```

- [x] **10.3** –°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å `services/payments.py` ‚úÖ
  - –°–æ–∑–¥–∞–Ω: services/payments.py
  - –í–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–Ω—É—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ error handling

- [x] **10.4** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `create_payment_link()` –≤ `payments.py` ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å –ø–æ–ª–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é
  - –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω `verify_payment()` –¥–ª—è webhook
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è (PRICING)
  ```python
  from yookassa import Payment, Configuration

  Configuration.account_id = config.YOOKASSA_SHOP_ID
  Configuration.secret_key = config.YOOKASSA_SECRET_KEY

  async def create_payment_link(
      user_id: int,
      tier: str = 'pro',
      duration_days: int = 30
  ) -> str:
      """–°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ –ÆKassa"""
      amount = 2.99 if tier == 'pro' else 0

      payment = Payment.create({
          "amount": {
              "value": str(amount),
              "currency": "USD"
          },
          "confirmation": {
              "type": "redirect",
              "return_url": f"https://t.me/{config.BOT_USERNAME}"
          },
          "capture": True,
          "description": f"Pro subscription for {duration_days} days",
          "metadata": {
              "user_id": user_id,
              "tier": tier,
              "duration_days": duration_days
          }
      })

      return payment.confirmation.confirmation_url
  ```

- [x] **10.5** –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ö—É–ø–∏—Ç—å Pro (–ö–∞—Ä—Ç–∞)" –≤ `/premium` ‚úÖ
  - –û–±–Ω–æ–≤–ª–µ–Ω modules/commands.py:
    - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ "buy_pro" - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
    - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ "buy_pro_card" - —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å—Å—ã–ª–∫—É
    - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ "buy_pro_tribute" - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Tribute
  - –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ user-friendly —Å–æ–æ–±—â–µ–Ω–∏—è
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ YooKassa –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞

- [x] **10.6** –°–æ–∑–¥–∞—Ç—å webhook endpoint `api/yookassa_webhook.py` ‚úÖ
  - –°–æ–∑–¥–∞–Ω: api/yookassa_webhook.py
  - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
    - ‚úÖ IP verification (logged for monitoring)
    - ‚úÖ Payment verification —á–µ—Ä–µ–∑ YooKassa API
    - ‚úÖ Validation –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
    - ‚úÖ –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è audit trail
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
  - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
  ```python
  from flask import request, jsonify
  from yookassa import Payment

  def handler(request):
      """Webhook –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –ÆKassa"""
      try:
          event = request.get_json()

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ (–≤–∞–∂–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
          # ...

          if event['event'] == 'payment.succeeded':
              payment_id = event['object']['id']
              payment = Payment.find_one(payment_id)

              user_id = int(payment.metadata['user_id'])
              tier = payment.metadata['tier']
              duration_days = int(payment.metadata['duration_days'])

              # –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
              success = await create_or_update_subscription(
                  user_id=user_id,
                  tier=tier,
                  duration_days=duration_days,
                  payment_method='yookassa',
                  transaction_id=payment_id
              )

              if success:
                  # –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                  await bot.send_message(
                      chat_id=user_id,
                      text="üéâ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!\n\nPro-–ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞."
                  )

          return jsonify({'status': 'ok'}), 200
      except Exception as e:
          logger.error(f"Webhook error: {e}")
          return jsonify({'error': str(e)}), 500
  ```

- [x] **10.7** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏, –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ ‚úÖ
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ api/yookassa_webhook.py
  - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`
  - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ `verify_payment()` –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

- [ ] **10.8** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook URL –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ)
  - URL: `https://vkratse.vercel.app/api/yookassa_webhook`
  - **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** [YOOKASSA_SETUP_GUIDE.md](./YOOKASSA_SETUP_GUIDE.md) - –®–∞–≥ 4
  - –†—É—á–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–æ—Ç–∞

- [ ] **10.9 –¢–ï–°–¢:** –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ –ÆKassa ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
  - –ù–∞–∂–∞—Ç—å "–ö—É–ø–∏—Ç—å Pro (–ö–∞—Ä—Ç–∞)"
  - –ü—Ä–æ–π—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: webhook –ø–æ–ª—É—á–µ–Ω, –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –ø—Ä–∏—à–ª–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
  - **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** [YOOKASSA_SETUP_GUIDE.md](./YOOKASSA_SETUP_GUIDE.md) - –®–∞–≥ 5

---

### –®–∞–≥ 11: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Stars (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3) ‚úÖ

**–¶–µ–ª—å:** –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Telegram

- [x] **11.1** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `create_stars_invoice()` –≤ `payments.py` ‚úÖ
  - **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:** services/payments.py:302-398
  - –í–∫–ª—é—á–∞–µ—Ç STARS_PRICING —Å 3 –ø–ª–∞–Ω–∞–º–∏ (–º–µ—Å—è—Ü/–∫–≤–∞—Ä—Ç–∞–ª/–≥–æ–¥)
  - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: payload —Å user_id –∏ timestamp –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
  - –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  - Graceful error handling
  ```python
  async def create_stars_invoice(
      bot,  # Telegram Bot instance
      user_id: int,
      plan: str = 'pro_monthly'  # 'pro_monthly', 'pro_quarterly', 'pro_yearly'
  ) -> Dict[str, Any]:
      # Returns: {'success': bool, 'invoice_message': Message, ...}
  ```

- [x] **11.2** –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ö—É–ø–∏—Ç—å Pro (Stars)" –≤ `/premium` ‚úÖ
  - **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:** modules/commands.py:315-316
  - –ö–Ω–æ–ø–∫–∞ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–∫ YooKassa)
  - Callback: "buy_pro_stars"
  - –û–±—Ä–∞–±–æ—Ç—á–∏–∫: modules/commands.py:405-457

- [x] **11.3** –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `PreCheckoutQuery` ‚úÖ
  - **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:** modules/commands.py:826-900
  - –í–∞–ª–∏–¥–∞—Ü–∏—è payload format (stars_<user_id>_<tier>_<days>_<timestamp>)
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ user_id —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å payload
  - –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞—É–¥–∏—Ç–∞
  - –¢–∞–π–º–∞—É—Ç < 10 —Å–µ–∫—É–Ω–¥ (Telegram requirement)
  - Graceful error handling

- [x] **11.4** –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `SuccessfulPayment` ‚úÖ
  - **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:** modules/commands.py:903-1024
  - –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ user_id (security)
  - –ê–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ SubscriptionService
  - –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  - Transaction ID —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞
  - –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ + error handling

- [x] **11.5** –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ api/index.py ‚úÖ
  - **–ò–º–ø–æ—Ä—Ç—ã:** api/index.py:96-97
  - **PreCheckoutQueryHandler:** api/index.py:490-491
  - **MessageHandler (SUCCESSFUL_PAYMENT):** api/index.py:493-497

- [ ] **11.6 –¢–ï–°–¢:** –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤—É—é –ø–æ–∫—É–ø–∫—É —á–µ—Ä–µ–∑ Telegram Stars ‚è≠Ô∏è (–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
  - –ù–∞–∂–∞—Ç—å "–ö—É–ø–∏—Ç—å Pro (Stars)"
  - –ü—Ä–æ–π—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: `/mystatus` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç Pro-—Å—Ç–∞—Ç—É—Å
  - **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** [TESTING_TELEGRAM_STARS.md](./TESTING_TELEGRAM_STARS.md) - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è –Ω–µ-–ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞

**üìã –í–ê–ñ–ù–û - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:**
- –°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: [TESTING_TELEGRAM_STARS.md](./TESTING_TELEGRAM_STARS.md)
- –í–∫–ª—é—á–∞–µ—Ç 6 –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- –û–ø–∏—Å–∞–Ω—ã –æ–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Å–ø–æ—Å–æ–±—ã –æ—Ç–ª–∞–¥–∫–∏
- –ì–æ—Ç–æ–≤–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ-–ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–º
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø–æ–∫—É–ø–∫–µ Stars –∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–ª–∞—Ç–µ–∂–µ–π

---

### –®–∞–≥ 12: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

- [ ] **12.1** –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/help` —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Ç–∞—Ä–∏—Ñ–æ–≤
  ```python
  message += "\nüíé –¢–ê–†–ò–§–´\n"
  message += "/premium - –£–∑–Ω–∞—Ç—å –æ Pro-–ø–æ–¥–ø–∏—Å–∫–µ\n"
  message += "/mystatus - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å\n\n"
  ```

- [ ] **12.2** –ù–∞–ø–∏—Å–∞—Ç—å `README_MONETIZATION.md` —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –º–æ–¥–µ–ª–∏
  - –¢–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–æ–≤
  - –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã
  - FAQ

- [ ] **12.3** –ü–æ–ª–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
  ```
  –ë–ê–ó–û–í–´–ï –§–£–ù–ö–¶–ò–ò:
  [ ] Free: –ª–∏–º–∏—Ç 30 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å —Ä–∞–±–æ—Ç–∞–µ—Ç
  [ ] Free: –ª–∏–º–∏—Ç 3 summary –≤ –õ–°/–¥–µ–Ω—å —Ä–∞–±–æ—Ç–∞–µ—Ç
  [ ] Free: –ª–∏–º–∏—Ç 5 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –ª–∏—á–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
  [ ] Pro: –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
  [ ] Pro: –ª–∏–º–∏—Ç—ã —É–≤–µ–ª–∏—á–µ–Ω—ã (500 —Å–æ–æ–±—â–µ–Ω–∏–π)

  –ì–†–£–ü–ü–ê:
  [ ] Free + –≥—Ä—É–ø–ø–∞: 1 –±–æ–Ω—É—Å–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å
  [ ] Pro + –≥—Ä—É–ø–ø–∞: 4 –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏
  [ ] –í—ã—Ö–æ–¥ –∏–∑ –≥—Ä—É–ø–ø—ã: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±–æ–Ω—É—Å–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏
  [ ] –í–æ–∑–≤—Ä–∞—Ç –≤ –≥—Ä—É–ø–ø—É: —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ª–∏—á–Ω–æ—Å—Ç–∏

  –ü–û–î–ü–ò–°–ö–ê:
  [ ] /premium –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–∞—Ä–∏—Ñ—ã
  [ ] /mystatus –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
  [ ] –ò—Å—Ç–µ—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏: –∞–≤—Ç–æ–¥–∞—É–Ω–≥—Ä–µ–π–¥ –Ω–∞ Free
  [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏

  –û–ü–õ–ê–¢–ê:
  [ ] Tribute.to: —Ä—É—á–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è —á–µ—Ä–µ–∑ /grantpro
  [ ] –ÆKassa: –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —á–µ—Ä–µ–∑ webhook
  [ ] Telegram Stars: –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —á–µ—Ä–µ–∑ SuccessfulPayment
  ```

- [ ] **12.4** –ë–µ—Ç–∞-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å 1-2 –¥—Ä—É–∑—å—è–º–∏
  - –ü–æ–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–π—Ç–∏ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å: –æ—Ç Free –¥–æ Pro
  - –°–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
  - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –±–∞–≥–∏

- [ ] **12.5** Production deployment –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
  - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ environment variables —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ Vercel
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
  - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–µ—Ä–≤—ã—Ö 24 —á–∞—Å–æ–≤

---

## üìä –ü—Ä–æ–≥—Ä–µ—Å—Å

**–í—Å–µ–≥–æ –∑–∞–¥–∞—á:** 76
**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:** 63
**–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 83%

**–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø:** ‚úÖ –®–∞–≥ 11 –∑–∞–≤–µ—Ä—à–µ–Ω - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Stars (5/6 –∑–∞–¥–∞—á –∫–æ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ, 1 —Ç–µ—Å—Ç –≥–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é)
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:**
- –í–∞—Ä–∏–∞–Ω—Ç 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Telegram Stars (–®–∞–≥ 11.6) - [TESTING_TELEGRAM_STARS.md](./TESTING_TELEGRAM_STARS.md)
- –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å YooKassa –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å (–®–∞–≥ 10.8-10.9)
- –í–∞—Ä–∏–∞–Ω—Ç 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –®–∞–≥–æ–≤ 7-9 (–ì—Ä—É–ø–ø–∞, –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
- –í–∞—Ä–∏–∞–Ω—Ç 4: –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É - –®–∞–≥ 12 (–§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

**üîê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:** –ö–æ–º–∞–Ω–¥–∞ /grantpro —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π –∑–∞—â–∏—Ç–æ–π (admin auth, input validation, logging, error handling)

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ù–∞—á–∞—Ç—å —Å **–≠–¢–ê–ü–ê 1, –®–∞–≥ 1** - —Å–æ–∑–¥–∞–Ω–∏–µ SQL-–º–∏–≥—Ä–∞—Ü–∏–π
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Supabase
3. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —à–∞–≥ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É

---

## üìù –ó–∞–º–µ—Ç–∫–∏

- –í—Å–µ SQL-–º–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ `sql/migrations/`
- –ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å type hints –∏ docstrings
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏, –¥–∞—É–Ω–≥—Ä–µ–π–¥, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ª–∏—á–Ω–æ—Å—Ç–µ–π)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HMAC –¥–ª—è –≤—Å–µ—Ö callback_data
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ staging –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –Ω–∞ production

---

**–°–æ–∑–¥–∞–Ω–æ:** 2025-11-17
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-11-17
