# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

---

# ü§ñ –ß—Ç–æ –±—ã–ª–æ –≤ —á–∞—Ç–µ - Telegram Bot

## üìã –û –ø—Ä–æ–µ–∫—Ç–µ

**Telegram –±–æ—Ç –¥–ª—è AI-—Å–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ª–∏—á–Ω–æ—Å—Ç—è–º–∏.**

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:
- **Backend**: Python 3.11+, Vercel Serverless Functions
- **Database**: Supabase (PostgreSQL)
- **AI**: Claude API (Anthropic)
- **Bot Framework**: python-telegram-bot
- **Deployment**: Vercel (webhook mode)

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏ AI (7 –±–∞–∑–æ–≤—ã—Ö + –∫–∞—Å—Ç–æ–º–Ω—ã–µ)
- –ü—Ä—è–º–æ–µ –æ–±—â–µ–Ω–∏–µ —Å –±–æ—Ç–æ–º (direct chat) –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏
- –°–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —á–∞—Ç–æ–≤ –∑–∞ —Ä–∞–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã
- –°—É–¥–µ–π—Å—Ç–≤–æ —Å–ø–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ /rassudi
- –í—ã–±–æ—Ä —á–∞—Ç–æ–≤ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
- Inline-–º–µ–Ω—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (2 –¥–Ω—è)
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–æ–≤–µ—Ä–∫–∏ —á–ª–µ–Ω—Å—Ç–≤–∞, HMAC, sanitization)

---

## üó∫Ô∏è CUSTOMER JOURNEY MAP (CJM)

### –û–±—â–∞—è —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è UX:
1. **–ù–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ–≥–¥–∞ –¥–µ–ª–∞–µ—Ç –æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–π –≤—ã–±–æ—Ä
2. **–ò–Ω—Ç—Ä–∏–≥—É—é—â–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è** - –ª–∏—á–Ω–æ—Å—Ç–∏ —Å —è—Ä–∫–∏–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞–º–∏
3. **Inline-–º–µ–Ω—é** - –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º
4. **–ö–æ–Ω—Ç–µ–∫—Å—Ç 2 –¥–Ω—è** - –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
5. **–ü–æ–¥—Å–∫–∞–∑–∫–∏ –≤–µ–∑–¥–µ** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ–≥–¥–∞ –∑–Ω–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

---

### –ü—É—Ç—å 1: –õ–∏—á–Ω—ã–π —á–∞—Ç (Direct Chat —Å –±–æ—Ç–æ–º)

#### 1.1 –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç
**–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "Start" –∏–ª–∏ –ø–∏—à–µ—Ç /start

**–§–ª–æ—É:**
```
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å] ‚Üí /start
    ‚Üì
[–ë–æ—Ç] ‚Üí –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + Inline-–º–µ–Ω—é
    ‚îú‚îÄ üí¨ –û–±—â–∞—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É—é
    ‚îú‚îÄ üë• –î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç
    ‚îî‚îÄ üé≠ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `modules/commands.py:start()` - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
- Inline-–º–µ–Ω—é —á–µ—Ä–µ–∑ `InlineKeyboardMarkup` —Å callback_query
- HMAC –ø–æ–¥–ø–∏—Å—å –¥–ª—è –≤—Å–µ—Ö callback_data

**–¢–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è:**
```
üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ª–∏—á–Ω–æ—Å—Ç—è–º–∏.

–Ø –º–æ–≥—É:
‚Ä¢ –û–±—â–∞—Ç—å—Å—è —Å —Ç–æ–±–æ–π –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∏–ª—è—Ö
‚Ä¢ –°–∞–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã
‚Ä¢ –†–∞—Å—Å—É–∂–∏–≤–∞—Ç—å —Å–ø–æ—Ä—ã

–ß—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å?
```

#### 1.2 –í—ã–±–æ—Ä "–û–±—â–∞—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É—é"
**–¢—Ä–∏–≥–≥–µ—Ä:** –ö–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É "üí¨ –û–±—â–∞—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É—é"

**–§–ª–æ—É:**
```
[–ö–ª–∏–∫] ‚Üí callback_query: "direct_chat"
    ‚Üì
[–ë–æ—Ç] ‚Üí –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ª–∏—á–Ω–æ—Å—Ç–∏ (7 –±–∞–∑–æ–≤—ã—Ö + –∫–∞—Å—Ç–æ–º–Ω—ã–µ)
    ‚îú‚îÄ üè≠ –ë—ã–¥–ª–∞–Ω
    ‚îú‚îÄ üßô –§–∏–ª–æ—Å–æ—Ñ
    ‚îú‚îÄ üëü –ì–æ–ø–Ω–∏–∫
    ‚îú‚îÄ üíº –û–ª–∏–≥–∞—Ä—Ö
    ‚îú‚îÄ üòÇ –°—Ç–µ–Ω–¥–∞–ø–µ—Ä
    ‚îú‚îÄ üî¨ –£—á—ë–Ω—ã–π
    ‚îú‚îÄ üéì –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π
    ‚îú‚îÄ [–ö–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
    ‚îî‚îÄ ‚ûï –°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é –ª–∏—á–Ω–æ—Å—Ç—å
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `modules/direct_chat.py:show_personality_selection()` - –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å
- –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ª–∏—á–Ω–æ—Å—Ç–∏ –∏–∑ –ë–î (–±–∞–∑–æ–≤—ã–µ + –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ)
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤ 2 –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏

#### 1.3 –í—ã–±–æ—Ä –ª–∏—á–Ω–æ—Å—Ç–∏
**–¢—Ä–∏–≥–≥–µ—Ä:** –ö–ª–∏–∫ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ª–∏—á–Ω–æ—Å—Ç—å

**–§–ª–æ—É:**
```
[–ö–ª–∏–∫] ‚Üí callback_query: "select_personality:bydlan"
    ‚Üì
[–ë–î] ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä –≤ user_settings
    ‚Üì
[–ë–æ—Ç] ‚Üí –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç –ª–∏—á–Ω–æ—Å—Ç–∏
```

**–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π:**

**–ë—ã–¥–ª–∞–Ω:**
```
–ô–æ—É, –±—Ä–∞—Ç–∞–Ω! –ù—É —á–µ, –ø—Ä–∏–µ—Ö–∞–ª–∏? –ß–µ –Ω–∞–¥–æ?
–ù–µ —Å—Ç–æ–π –∫–∞–∫ —Å—Ç–æ–ª–±, –¥–∞–≤–∞–π –±–∞–∑–∞—Ä—å —á—ë –∫ —á–µ–º—É! üè≠
```

**–§–∏–ª–æ—Å–æ—Ñ:**
```
–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è, –ø—É—Ç–Ω–∏–∫. –¢—ã –ø—Ä–∏—à—ë–ª –≤ –ø–æ–∏—Å–∫–∞—Ö –∏—Å—Ç–∏–Ω—ã,
–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–±–ª—É–¥–∏–ª—Å—è –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ –±—ã—Ç–∏—è? üßô
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `modules/direct_chat.py:set_personality()` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞
- `services/db_service.py:update_user_personality()` - –ë–î –æ–ø–µ—Ä–∞—Ü–∏—è
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `personalities.greeting_message`
- –ï—Å–ª–∏ `greeting_message` NULL ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ Claude API

#### 1.4 –û–±—â–µ–Ω–∏–µ —Å –±–æ—Ç–æ–º
**–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

**–§–ª–æ—É:**
```
[–°–æ–æ–±—â–µ–Ω–∏–µ] ‚Üí "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?"
    ‚Üì
[–ë–î] ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ messages
    ‚Üì
[–ë–î] ‚Üí –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π (–∫–æ–Ω—Ç–µ–∫—Å—Ç)
    ‚Üì
[Claude API] ‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –≤ —Å—Ç–∏–ª–µ –ª–∏—á–Ω–æ—Å—Ç–∏
    ‚Üì
[–ë–æ—Ç] ‚Üí –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    ‚Üì
[–ë–î] ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –≤ messages
```

**–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ª–∏–º–∏—Ç—ã:**
- –•—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –¥–Ω—è —Å–æ–æ–±—â–µ–Ω–∏–π (–∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞)
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20-30 —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `modules/direct_chat.py:handle_message()` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
- `services/ai_service.py:generate_chat_response()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
- `services/db_service.py:get_chat_history()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏

#### 1.5 –°–º–µ–Ω–∞ –ª–∏—á–Ω–æ—Å—Ç–∏
**–¢—Ä–∏–≥–≥–µ—Ä:** –ö–æ–º–∞–Ω–¥–∞ /lichnost –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ –≤ –º–µ–Ω—é

**–§–ª–æ—É:**
```
[–ö–æ–º–∞–Ω–¥–∞] ‚Üí /lichnost
    ‚Üì
[–ë–æ—Ç] ‚Üí –ú–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–µ–π (–∫–∞–∫ –≤ 1.2)
    ‚Üì
[–í—ã–±–æ—Ä] ‚Üí –ù–æ–≤–∞—è –ª–∏—á–Ω–æ—Å—Ç—å
    ‚Üì
[–ë–æ—Ç] ‚Üí "–õ–∏—á–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ [–Ω–∞–∑–≤–∞–Ω–∏–µ]. –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞."
    ‚Üì
[–î–∞–ª—å–Ω–µ–π—à–µ–µ –æ–±—â–µ–Ω–∏–µ] ‚Üí –í –Ω–æ–≤–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –ò—Å—Ç–æ—Ä–∏—è –ù–ï –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –ª–∏—á–Ω–æ—Å—Ç–∏
- –ü—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è system_prompt –¥–ª—è Claude API
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–µ–Ω–∏–ª –ª–∏—á–Ω–æ—Å—Ç—å –Ω–∞ X"

#### 1.6 –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏
**–¢—Ä–∏–≥–≥–µ—Ä:** –ö–ª–∏–∫ –Ω–∞ "‚ûï –°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é –ª–∏—á–Ω–æ—Å—Ç—å"

**–§–ª–æ—É:**
```
[–ö–ª–∏–∫] ‚Üí callback_query: "create_personality"
    ‚Üì
[–ë–æ—Ç] ‚Üí "–û–ø–∏—à–∏ —Å—Ç–∏–ª—å –ª–∏—á–Ω–æ—Å—Ç–∏ (10-500 —Å–∏–º–≤–æ–ª–æ–≤):"
    ‚Üì
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å] ‚Üí "–ì—Ä—É–±—ã–π –º–∞—Ç–µ–º–∞—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä—è—Å–Ω—è–µ—Ç —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É–ª—ã"
    ‚Üì
[–í–∞–ª–∏–¥–∞—Ü–∏—è] ‚Üí Sanitization + –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤
    ‚Üì
[–ë–æ—Ç] ‚Üí "–î–∞–π –∏–º—è –ª–∏—á–Ω–æ—Å—Ç–∏:"
    ‚Üì
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å] ‚Üí "–ú–∞—Ç–µ–º–∞—Ç–∏–∫-–≥—Ä—É–±–∏—è–Ω"
    ‚Üì
[–ë–î] ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ personalities (is_custom=true)
    ‚Üì
[–ë–æ—Ç] ‚Üí –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç –Ω–æ–≤–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ Claude)
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `modules/personalities.py` - ConversationHandler –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
- –õ–∏–º–∏—Ç: 5 –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- Sanitization –æ—Ç prompt injection
- –ó–∞–ø—Ä–µ—Ç –∏–º—ë–Ω —Ä–µ–∞–ª—å–Ω—ã—Ö –ª—é–¥–µ–π/–±—Ä–µ–Ω–¥–æ–≤

---

### –ü—É—Ç—å 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç

#### 2.1 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É
**–¢—Ä–∏–≥–≥–µ—Ä:** –ö–ª–∏–∫ –Ω–∞ "üë• –î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç"

**–§–ª–æ—É:**
```
[–ö–ª–∏–∫] ‚Üí callback_query: "add_to_group"
    ‚Üì
[–ë–æ—Ç] ‚Üí CTA-—Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –ø–æ–ª—å–∑—ã
    + Inline-–∫–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É" (URL)
    ‚Üì
[–ö–ª–∏–∫] ‚Üí Telegram –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã
    ‚Üì
[–î–æ–±–∞–≤–ª–µ–Ω–∏–µ] ‚Üí –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ "my_chat_member"
    ‚Üì
[–ë–î] ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å chat_metadata
    ‚Üì
[–ë–æ—Ç] ‚Üí Welcome-—Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ
```

**CTA-—Å–æ–æ–±—â–µ–Ω–∏–µ:**
```
üéâ –î–æ–±–∞–≤—å –º–µ–Ω—è –≤ —Å–≤–æ—é –≥—Ä—É–ø–ø—É!

–Ø —Å–º–æ–≥—É:
‚úÖ –°–∞–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—Å—É–∂–¥–µ–Ω–∏—è
‚úÖ –†–∞—Å—Å—É–∂–∏–≤–∞—Ç—å —Å–ø–æ—Ä—ã
‚úÖ –û–±—â–∞—Ç—å—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∏–ª—è—Ö

üí° –î–∞–π –º–Ω–µ –∞–¥–º–∏–Ω-–ø—Ä–∞–≤–∞ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞!

[–ö–Ω–æ–ø–∫–∞: –î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É ‚Üí]
```

**URL –¥–ª—è –∫–Ω–æ–ø–∫–∏:**
```
https://t.me/YourBot?startgroup=true
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `modules/onboarding.py:show_add_to_group()` - –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å
- `api/index.py:handle_my_chat_member()` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
- `services/db_service.py:create_chat_metadata()` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

#### 2.2 Welcome-—Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ
**–¢—Ä–∏–≥–≥–µ—Ä:** –ë–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É

**–§–ª–æ—É:**
```
[–°–æ–±—ã—Ç–∏–µ] ‚Üí "my_chat_member" (status: member/administrator)
    ‚Üì
[–ë–î] ‚Üí –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ chat_metadata
    ‚Üì
[–ë–æ—Ç] ‚Üí Welcome-—Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ + GIF/–∫–∞—Ä—Ç–∏–Ω–∫–∞
```

**Welcome-—Å–æ–æ–±—â–µ–Ω–∏–µ:**
```
üëã –ü—Ä–∏–≤–µ—Ç, –Ω–∞—Ä–æ–¥!

–Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å! –í–æ—Ç —á—Ç–æ —è —É–º–µ—é:

üìù /summary - –°–∞–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—Å—É–∂–¥–µ–Ω–∏—è
‚öñÔ∏è /rassudi - –†–∞—Å—Å—É–¥–∏—Ç—å —Å–ø–æ—Ä
üí¨ /chat - –ü–æ–æ–±—â–∞—Ç—å—Å—è –≤ –≥—Ä—É–ø–ø–µ

üí° –î–∞–π—Ç–µ –º–Ω–µ –∞–¥–º–∏–Ω-–ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã —è –º–æ–≥:
‚Ä¢ –ß–∏—Ç–∞—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
‚Ä¢ –£–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

–ö–æ–º–∞–Ω–¥—ã: /help
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `modules/onboarding.py:send_group_welcome()`
- –ö–∞—Ä—Ç–∏–Ω–∫–∞/GIF —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ file_id –≤ config.py
- –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –±–æ—Ç —É–∂–µ –±—ã–ª –≤ –≥—Ä—É–ø–ø–µ ‚Üí –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å welcome

#### 2.3 –†–∞–±–æ—Ç–∞ —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ –≤ –≥—Ä—É–ø–ø–µ

##### –ö–æ–º–∞–Ω–¥–∞ /summary (–∞–Ω–∞–ª–æ–≥ /sut)
**–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç `/summary` –∏–ª–∏ `/summary 100`

**–§–ª–æ—É:**
```
[–ö–æ–º–∞–Ω–¥–∞] ‚Üí /summary [–ø–∞—Ä–∞–º–µ—Ç—Ä]
    ‚Üì
[–ü—Ä–æ–≤–µ—Ä–∫–∏] ‚Üí
    ‚îú‚îÄ Cooldown (60 —Å–µ–∫ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∞–º–º–∞—Ä–∏)
    ‚îú‚îÄ Rate limiting (10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω –Ω–∞ —á–∞—Ç)
    ‚îî‚îÄ –ß–ª–µ–Ω—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ
    ‚Üì
[–ë–æ—Ç] ‚Üí –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ª–∏—á–Ω–æ—Å—Ç–∏ (inline-–∫–Ω–æ–ø–∫–∏)
    ‚Üì
[–í—ã–±–æ—Ä] ‚Üí callback_query: "summary_personality:bydlan:100"
    ‚Üì
[–ë–î] ‚Üí –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π
    ‚Üì
[Claude API] ‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∞–º–º–∞—Ä–∏ –≤ —Å—Ç–∏–ª–µ –ª–∏—á–Ω–æ—Å—Ç–∏
    ‚Üì
[–ë–æ—Ç] ‚Üí –û—Ç–≤–µ—Ç –≤ —á–∞—Ç
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `/summary` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–µ—Ñ–æ–ª—Ç)
- `/summary 100` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
- `/summary 2h` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —á–∞—Å–∞
- `/summary today` - —Å –Ω–∞—á–∞–ª–∞ –¥–Ω—è

**Inline-–º–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–µ–π:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üè≠ –ë—ã–¥–ª–∞–Ω ‚îÇ üßô –§–∏–ª–æ—Å–æ—Ñ ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üëü –ì–æ–ø–Ω–∏–∫ ‚îÇ üíº –û–ª–∏–≥–∞—Ä—Ö ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üòÇ –ö–æ–º–∏–∫  ‚îÇ üî¨ –£—á—ë–Ω—ã–π ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `modules/summaries.py:handle_summary_command()` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
- –û—Ç–ª–∏—á–∏–µ –æ—Ç /sut: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–µ–π —Å—Ä–∞–∑—É –≤ –≥—Ä—É–ø–ø–µ
- HMAC –ø–æ–¥–ø–∏—Å—å –¥–ª—è callback_data
- Callback —Å–æ–¥–µ—Ä–∂–∏—Ç: personality + –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ/–ø–µ—Ä–∏–æ–¥)

##### –ö–æ–º–∞–Ω–¥–∞ /chat
**–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç `/chat` –≤ –≥—Ä—É–ø–ø–µ

**–§–ª–æ—É:**
```
[–ö–æ–º–∞–Ω–¥–∞] ‚Üí /chat
    ‚Üì
[–ü—Ä–æ–≤–µ—Ä–∫–∏] ‚Üí
    ‚îú‚îÄ –£–∂–µ –∞–∫—Ç–∏–≤–Ω–∞ —Å–µ—Å—Å–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —é–∑–µ—Ä–∞?
    ‚îî‚îÄ Cooldown –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (30 —Å–µ–∫)
    ‚Üì
[–ë–æ—Ç] ‚Üí –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ª–∏—á–Ω–æ—Å—Ç–∏
    ‚Üì
[–í—ã–±–æ—Ä] ‚Üí callback_query: "start_chat:bydlan"
    ‚Üì
[–ë–î] ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é —Å–µ—Å—Å–∏—é (user_id + chat_id + personality)
    ‚Üì
[–ë–æ—Ç] ‚Üí "–ü—Ä–∏–≤–µ—Ç –æ—Ç [–ª–∏—á–Ω–æ—Å—Ç—å]! –ü–∏—à–∏ –º–Ω–µ —á–µ—Ä–µ–∑ reply –∏–ª–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ."
    ‚Üì
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å] ‚Üí –ü–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ (reply –∏–ª–∏ @bot)
    ‚Üì
[–û–±—Ä–∞–±–æ—Ç–∫–∞] ‚Üí –¢–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è —ç—Ç–æ–≥–æ —é–∑–µ—Ä–∞ ‚Üí –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
    ‚Üì
[–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ] ‚Üí –ö–æ–º–∞–Ω–¥–∞ /stop –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç 15 –º–∏–Ω—É—Ç
```

**–ê–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è:**
- –•—Ä–∞–Ω–∏—Ç—Å—è –≤ `bot_data` (in-memory) –∏–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ `active_chat_sessions`
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `{user_id: {chat_id, personality, started_at, last_activity}}`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `modules/direct_chat.py:start_group_chat_session()` - –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è
- `modules/direct_chat.py:handle_group_chat_message()` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
- –§–∏–ª—å—Ç—Ä: —Ç–æ–ª—å–∫–æ reply –Ω–∞ –±–æ—Ç–∞ –∏–ª–∏ @mention
- –ö–æ–Ω—Ç–µ–∫—Å—Ç: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10-15 —Å–æ–æ–±—â–µ–Ω–∏–π —Å–µ—Å—Å–∏–∏

##### –ö–æ–º–∞–Ω–¥–∞ /rassudi
**–¢—Ä–∏–≥–≥–µ—Ä:** `/rassudi @user1 @user2 –ö—Ç–æ –ø—Ä–∞–≤ –≤ —Å–ø–æ—Ä–µ?`

**–§–ª–æ—É:**
```
[–ö–æ–º–∞–Ω–¥–∞] ‚Üí /rassudi @user1 @user2 [–æ–ø–∏—Å–∞–Ω–∏–µ]
    ‚Üì
[–í–∞–ª–∏–¥–∞—Ü–∏—è] ‚Üí
    ‚îú‚îÄ –ï—Å—Ç—å –ª–∏ —É–ø–æ–º—è–Ω—É—Ç—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏?
    ‚îú‚îÄ –ï—Å—Ç—å –ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–ø–æ—Ä–∞?
    ‚îî‚îÄ Cooldown (60 —Å–µ–∫)
    ‚Üì
[–ë–æ—Ç] ‚Üí –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ª–∏—á–Ω–æ—Å—Ç–∏
    ‚Üì
[–í—ã–±–æ—Ä] ‚Üí callback_query: "judge_personality:bydlan:user1:user2"
    ‚Üì
[–ë–î] ‚Üí –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç @user1 –∏ @user2
    ‚Üì
[Claude API] ‚Üí –ê–Ω–∞–ª–∏–∑ + –≤–µ—Ä–¥–∏–∫—Ç –≤ —Å—Ç–∏–ª–µ –ª–∏—á–Ω–æ—Å—Ç–∏
    ‚Üì
[–ë–æ—Ç] ‚Üí –í–µ—Ä–¥–∏–∫—Ç –≤ —á–∞—Ç
```

**–§–æ—Ä–º–∞—Ç –≤–µ—Ä–¥–∏–∫—Ç–∞ (–ø—Ä–∏–º–µ—Ä "–ë—ã–¥–ª–∞–Ω"):**
```
‚öñÔ∏è –í–ï–†–î–ò–ö–¢ –û–¢ –ë–´–î–õ–ê–ù–ê:

–ù—É –∫–æ—Ä–æ—á–µ —Ç–∞–∫, –ø–∞—Ü–∞–Ω—ã...

@user1 - –±–∞–∑–∞—Ä–∏—Ç –æ–¥–Ω–æ, –Ω–æ –≤ —Å–∞–º–æ–º –¥–µ–ª–µ —Ö*—ë–≤–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∏—Ç.
@user2 - –≤—Ä–æ–¥–µ –ø–æ –¥–µ–ª—É, –Ω–æ —Ç–æ–∂–µ —Ö—É–π–Ω—é –Ω–µ—Å—ë—Ç.

–ò–¢–û–ì: –û–±–∞ –∫–ª–æ—É–Ω—ã, –Ω–æ @user2 —á—É—Ç—å –º–µ–Ω—å—à–µ.

üè≠ –ë—ã–¥–ª–∞–Ω –ø–æ—Å—Ç–∞–Ω–æ–≤–∏–ª. –ë–∞–∑–∞—Ä–∞ –Ω–µ—Ç.
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `modules/judge.py:handle_judge_command()` - —É–∂–µ –µ—Å—Ç—å
- –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–µ–π –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
- –ü–∞—Ä—Å–∏–Ω–≥ @username –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∫–æ–º–∞–Ω–¥—ã
- –§–æ—Ä–º–∞—Ç callback: `judge:personality:user_ids_hash`

#### 2.4 –ö–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ —Å–ª—ç—à-–º–µ–Ω—é
**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ BotFather:**

```
/setcommands

start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
help - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
summary - –°–∞–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ
chat - –ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ
rassudi - –†–∞—Å—Å—É–¥–∏—Ç—å —Å–ø–æ—Ä
lichnost - –í—ã–±—Ä–∞—Ç—å/—Å–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å
stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –ö–æ–º–∞–Ω–¥—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ —á–µ—Ä–µ–∑ BotFather
- –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "/" —Å –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–æ–º
- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–º–æ–≥–∞—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ–Ω—è—Ç—å, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–º–∞–Ω–¥–∞

---

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –Ω–æ–≤—ã—Ö —Ñ–∏—á

#### –ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏:
```
modules/
‚îú‚îÄ‚îÄ direct_chat.py         # NEW: –ü—Ä—è–º–æ–µ –æ–±—â–µ–Ω–∏–µ —Å –±–æ—Ç–æ–º
‚îú‚îÄ‚îÄ onboarding.py          # NEW: Welcome-—Å–æ–æ–±—â–µ–Ω–∏—è, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—ã
‚îú‚îÄ‚îÄ summaries.py           # UPDATE: –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä –ª–∏—á–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ judge.py               # UPDATE: –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä –ª–∏—á–Ω–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ personalities.py       # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```

#### –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –ë–î:
```sql
-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è –ª–∏—á–Ω–æ—Å—Ç–µ–π
ALTER TABLE personalities
ADD COLUMN greeting_message TEXT DEFAULT NULL;

-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ bot_data)
CREATE TABLE active_chat_sessions (
  id SERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,
  chat_id BIGINT NOT NULL,
  personality VARCHAR(100) NOT NULL,
  started_at TIMESTAMP DEFAULT NOW(),
  last_activity TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, chat_id)
);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å–µ—Å—Å–∏–π
CREATE INDEX idx_sessions_activity ON active_chat_sessions(last_activity);
```

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
```python
# config.py - –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

# Direct chat settings
DIRECT_CHAT_CONTEXT_MESSAGES = 30  # –°–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
DIRECT_CHAT_SESSION_TIMEOUT = 900  # 15 –º–∏–Ω—É—Ç (–¥–ª—è –≥—Ä—É–ø–ø)

# Group chat settings
GROUP_CHAT_WELCOME_IMAGE_ID = "AgACAgIAAxkBAAI..."  # file_id –∫–∞—Ä—Ç–∏–Ω–∫–∏
GROUP_ADD_URL = "https://t.me/YourBot?startgroup=true"

# Personality settings
DEFAULT_GREETING_ENABLED = True  # –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ API
NO_DEFAULT_PERSONALITY = True    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –ª–∏—á–Ω–æ—Å—Ç–∏

# Rate limiting –¥–ª—è /chat
CHAT_SESSION_COOLDOWN = 30  # 30 —Å–µ–∫ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏ /chat
```

---

### UX-–ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

#### –°—Ü–µ–Ω–∞—Ä–∏–∏ –æ—à–∏–±–æ–∫:

**1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –±–æ—Ç—É –±–µ–∑ –≤—ã–±–æ—Ä–∞ –ª–∏—á–Ω–æ—Å—Ç–∏:**
```
[–°–æ–æ–±—â–µ–Ω–∏–µ] ‚Üí "–ü—Ä–∏–≤–µ—Ç"
    ‚Üì
[–ü—Ä–æ–≤–µ—Ä–∫–∞] ‚Üí selected_personality == NULL
    ‚Üì
[–ë–æ—Ç] ‚Üí "–í—ã–±–µ—Ä–∏ –ª–∏—á–Ω–æ—Å—Ç—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ: /lichnost"
```

**2. –ö–æ–º–∞–Ω–¥–∞ /summary –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ:**
```
[–ö–æ–º–∞–Ω–¥–∞] ‚Üí /summary
    ‚Üì
[–ë–î] ‚Üí 0 —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞–π–¥–µ–Ω–æ
    ‚Üì
[–ë–æ—Ç] ‚Üí "–í —á–∞—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–∞–º–º–∞—Ä–∏. –ù–∞–ø–∏—à–∏—Ç–µ —Ö–æ—Ç—è –±—ã 10 —Å–æ–æ–±—â–µ–Ω–∏–π!"
```

**3. –ö–æ–º–∞–Ω–¥–∞ /rassudi –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π:**
```
[–ö–æ–º–∞–Ω–¥–∞] ‚Üí /rassudi –ö—Ç–æ –ø—Ä–∞–≤?
    ‚Üì
[–ü–∞—Ä—Å–∏–Ω–≥] ‚Üí –ù–µ—Ç @username
    ‚Üì
[–ë–æ—Ç] ‚Üí "–£–∫–∞–∂–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–ø–æ—Ä–∞ —á–µ—Ä–µ–∑ @username!\n–ü—Ä–∏–º–µ—Ä: /rassudi @ivan @petya –ö—Ç–æ –ø—Ä–∞–≤?"
```

**4. –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ –≤ direct chat:**
```
[Claude API] ‚Üí Error: context_length_exceeded
    ‚Üì
[–ë–æ—Ç] ‚Üí "–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω! –Ø –ø–æ–º–Ω—é —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –¥–Ω—è.\n–ù–∞—á–Ω–∏ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥: /start"
```

**5. Cooldown –∞–∫—Ç–∏–≤–µ–Ω:**
```
[–ö–æ–º–∞–Ω–¥–∞] ‚Üí /summary
    ‚Üì
[–ü—Ä–æ–≤–µ—Ä–∫–∞] ‚Üí –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–∞–º–º–∞—Ä–∏ 30 —Å–µ–∫ –Ω–∞–∑–∞–¥
    ‚Üì
[–ë–æ—Ç] ‚Üí "–ü–æ–¥–æ–∂–¥–∏ –µ—â—ë 30 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º —Å–∞–º–º–∞—Ä–∏ ‚è±Ô∏è"
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `utils/validators.py:validate_command_input()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
- –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `analytics`)
- User-friendly —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### –ü—Ä–∏–Ω—Ü–∏–ø—ã:
1. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –∫–∞–∂–¥–∞—è —Ñ–∏—á–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ
2. **–°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å** - –º–∏–Ω–∏–º—É–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
3. **–¢–∏–ø–∏–∑–∞—Ü–∏—è** - type hints –≤–µ–∑–¥–µ
4. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ—Å—Ç—å** - –≤—Å—ë —á–µ—Ä–µ–∑ config.py
5. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –º–æ–¥—É–ª–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:

```
vkratse/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ index.py              # Webhook entry point (Vercel handler)
‚îÇ
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ direct_chat.py        # NEW: –ü—Ä—è–º–æ–µ –æ–±—â–µ–Ω–∏–µ —Å –±–æ—Ç–æ–º (1-–Ω–∞-1)
‚îÇ   ‚îú‚îÄ‚îÄ onboarding.py         # NEW: Welcome, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—ã
‚îÇ   ‚îú‚îÄ‚îÄ summaries.py          # /sut, /summary + callback handlers
‚îÇ   ‚îú‚îÄ‚îÄ personalities.py      # /lichnost + —Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ judge.py              # /rassudi - —Å—É–¥–µ–π—Å—Ç–≤–æ —Å–ø–æ—Ä–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ commands.py           # /start, /help, /stats
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ ai_service.py         # –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ Claude API
‚îÇ   ‚îú‚îÄ‚îÄ db_service.py         # –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ Supabase
‚îÇ   ‚îî‚îÄ‚îÄ persistence.py        # User data persistence
‚îÇ
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ message.py            # –ú–æ–¥–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ personality.py        # –ú–æ–¥–µ–ª—å –ª–∏—á–Ω–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ user.py               # –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îú‚îÄ‚îÄ chat.py               # –ú–æ–¥–µ–ª—å —á–∞—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ session.py            # NEW: –ú–æ–¥–µ–ª—å –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞
‚îÇ
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ security.py           # HMAC, sanitization
‚îÇ   ‚îú‚îÄ‚îÄ rate_limit.py         # Rate limiting
‚îÇ   ‚îú‚îÄ‚îÄ cooldown.py           # Cooldown —á–∞—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ time_parser.py        # –ü–∞—Ä—Å–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ validators.py         # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ cleanup_old_messages.py  # –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ –ë–î
‚îÇ
‚îú‚îÄ‚îÄ sql/
‚îÇ   ‚îú‚îÄ‚îÄ init_tables.sql       # –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
‚îÇ   ‚îú‚îÄ‚îÄ seed_personalities.sql # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π
‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îÇ       ‚îú‚îÄ‚îÄ 001_add_greetings.sql    # NEW: –î–æ–±–∞–≤–∏—Ç—å greeting_message
‚îÇ       ‚îî‚îÄ‚îÄ 002_chat_sessions.sql    # NEW: –¢–∞–±–ª–∏—Ü–∞ active_chat_sessions
‚îÇ
‚îú‚îÄ‚îÄ config.py                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (env vars)
‚îú‚îÄ‚îÄ requirements.txt          # Python dependencies
‚îú‚îÄ‚îÄ vercel.json              # Vercel configuration
‚îú‚îÄ‚îÄ README.md                # –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ README_CLEANUP.md        # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ cleanup —Å–∫—Ä–∏–ø—Ç—É
‚îî‚îÄ‚îÄ CLAUDE.md                # –≠—Ç–æ—Ç —Ñ–∞–π–ª (–¥–ª—è Claude Code)
```

---

## üóÑÔ∏è –°–•–ï–ú–ê –î–ê–ù–ù–´–• (Supabase)

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

#### `messages`
```sql
CREATE TABLE messages (
  id BIGSERIAL PRIMARY KEY,
  chat_id BIGINT NOT NULL,
  user_id BIGINT,
  username TEXT,
  message_text TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  INDEX idx_chat_time (chat_id, created_at DESC)
);
```
**–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞:** 2 –¥–Ω—è (–ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏)

#### `personalities`
```sql
CREATE TABLE personalities (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) UNIQUE NOT NULL,
  display_name VARCHAR(100) NOT NULL,
  emoji VARCHAR(10) DEFAULT 'üé≠',
  system_prompt TEXT NOT NULL,
  greeting_message TEXT DEFAULT NULL,        -- NEW: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
  is_custom BOOLEAN DEFAULT FALSE,
  created_by_user_id BIGINT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### `active_chat_sessions` (NEW)
```sql
CREATE TABLE active_chat_sessions (
  id SERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,
  chat_id BIGINT NOT NULL,
  personality VARCHAR(100) NOT NULL,
  started_at TIMESTAMP DEFAULT NOW(),
  last_activity TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, chat_id),
  INDEX idx_sessions_activity (last_activity)
);
```
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π /chat –≤ –≥—Ä—É–ø–ø–∞—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–Ω–∞ —Å–µ—Å—Å–∏—è –Ω–∞ —á–∞—Ç

#### `user_settings`
```sql
CREATE TABLE user_settings (
  user_id BIGINT PRIMARY KEY,
  username TEXT,
  selected_personality VARCHAR(100) DEFAULT 'neutral',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### `chat_metadata`
```sql
CREATE TABLE chat_metadata (
  chat_id BIGINT PRIMARY KEY,
  chat_title TEXT,
  chat_type TEXT,
  bot_added_at TIMESTAMP DEFAULT NOW(),
  last_activity TIMESTAMP DEFAULT NOW()
);
```

#### `cooldowns`
```sql
CREATE TABLE cooldowns (
  chat_id BIGINT PRIMARY KEY,
  last_summary_at TIMESTAMP,
  last_judge_at TIMESTAMP,
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### `analytics`
```sql
CREATE TABLE analytics (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT,
  chat_id BIGINT,
  event_type VARCHAR(50),
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## üì± –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê

**–í–ê–ñ–ù–û:** –ö–æ–º–∞–Ω–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –õ–ê–¢–ò–ù–°–ö–ò–ï –Ω–∞–∑–≤–∞–Ω–∏—è (Telegram API —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ)

### `/start`
–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + Inline-–º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—è
- üí¨ –û–±—â–∞—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É—é
- üë• –î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç
- üé≠ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
- –í **–õ–°**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω–æ–µ –º–µ–Ω—é
- –í **–≥—Ä—É–ø–ø–µ**: –∫—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ + /help

### `/help`
–ü–æ–ª–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –≤—Å–µ–º –∫–æ–º–∞–Ω–¥–∞–º —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏

### `/summary [–ø–µ—Ä–∏–æ–¥]` (NEW)
–°–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ —Å –≤—ã–±–æ—Ä–æ–º –ª–∏—á–Ω–æ—Å—Ç–∏
- –í **–≥—Ä—É–ø–ø–µ**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–µ–π ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∞–º–º–∞—Ä–∏
- –í **–õ–°**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞ ‚Üí –º–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–µ–π

**–ü—Ä–∏–º–µ—Ä—ã:**
- `/summary` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π
- `/summary 100` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
- `/summary 2h` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —á–∞—Å–∞
- `/summary today` - —Å –Ω–∞—á–∞–ª–∞ –¥–Ω—è

**–û—Ç–ª–∏—á–∏–µ –æ—Ç /sut:** –í—Å–µ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ª–∏—á–Ω–æ—Å—Ç–∏

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** HMAC –ø–æ–¥–ø–∏—Å—å, –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–ª–µ–Ω—Å—Ç–≤–∞, rate limiting, cooldown

### `/sut [–ø–µ—Ä–∏–æ–¥]`
–°–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ (legacy, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –ª–∏—á–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- –í **–≥—Ä—É–ø–ø–µ**: —Å–∞–º–º–∞—Ä–∏ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
- –í **–õ–°**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `/summary` –¥–ª—è –±–æ–ª—å—à–µ–π –≥–∏–±–∫–æ—Å—Ç–∏

### `/chat` (NEW)
–ù–∞—á–∞—Ç—å –ø—Ä—è–º–æ–µ –æ–±—â–µ–Ω–∏–µ —Å –±–æ—Ç–æ–º –≤ –≥—Ä—É–ø–ø–µ
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ª–∏—á–Ω–æ—Å—Ç–∏
- –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—á–µ—Ä–µ–∑ reply/mention)
- –°–µ—Å—Å–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—Ä—É—á–Ω—É—é: `/stop`

**–¢–æ–ª—å–∫–æ –¥–ª—è –≥—Ä—É–ø–ø!** –í –õ–° –Ω–µ –Ω—É–∂–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä—è–º–æ–µ –æ–±—â–µ–Ω–∏–µ)

### `/rassudi @user1 @user2 <–æ–ø–∏—Å–∞–Ω–∏–µ>`
–†–∞—Å—Å—É–¥–∏—Ç—å —Å–ø–æ—Ä —Å –≤—ã–±–æ—Ä–æ–º –ª–∏—á–Ω–æ—Å—Ç–∏ —Å—É–¥—å–∏
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç —É–ø–æ–º—è–Ω—É—Ç—ã—Ö @username
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ª–∏—á–Ω–æ—Å—Ç–∏
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –í—ã–¥–∞—ë—Ç –≤–µ—Ä–¥–∏–∫—Ç –≤ —Å—Ç–∏–ª–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–º–µ—Ä:**
```
/rassudi @ivan @petya –ö—Ç–æ –ø—Ä–∞–≤ –Ω–∞—Å—á–µ—Ç –≤—ã–±–æ—Ä–∞ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞?
```

### `/lichnost`
–í—ã–±–æ—Ä/—Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏ AI
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç 7 –±–∞–∑–æ–≤—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ 5 —à—Ç—É–∫)
- –ö–Ω–æ–ø–∫–∞ "‚ûï –°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é –ª–∏—á–Ω–æ—Å—Ç—å"
- –í—ã–±—Ä–∞–Ω–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π

### `/stats`
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∞–º–º–∞—Ä–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–æ—Ä–æ–≤ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–æ
- –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞
- –õ—é–±–∏–º–∞—è –ª–∏—á–Ω–æ—Å—Ç—å

### `/stop` (NEW)
–ó–∞–≤–µ—Ä—à–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é —Å–µ—Å—Å–∏—é /chat –≤ –≥—Ä—É–ø–ø–µ
- –¢–æ–ª—å–∫–æ –¥–ª—è –≥—Ä—É–ø–ø
- –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ /chat

---

## üé≠ –õ–ò–ß–ù–û–°–¢–ò AI (7 –±–∞–∑–æ–≤—ã—Ö)

–í—Å–µ –ª–∏—á–Ω–æ—Å—Ç–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î (`personalities` —Ç–∞–±–ª–∏—Ü–∞):

1. **üéì –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π (neutral)** - –¥–µ—Ñ–æ–ª—Ç, –≤–µ–∂–ª–∏–≤—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π
2. **üè≠ –ë—ã–¥–ª–∞–Ω (bydlan)** - –∑–∞–≤–æ–¥—á–∞–Ω–∏–Ω, –º–∞—Ç—é–∫–∞–µ—Ç—Å—è, –ø—Ä–æ –∞–≤—Ç–æ–º–æ–π–∫—É
3. **üßô –§–∏–ª–æ—Å–æ—Ñ (philosopher)** - –º—É–¥—Ä–µ—Ü, –≥–ª—É–±–æ–∫–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è
4. **üëü –ì–æ–ø–Ω–∏–∫ (gopnik)** - –ø–∞—Ü–∞–Ω –∏–∑ 2000-—Ö, —Å–ª–µ–Ω–≥, –ø–æ–¥—ä–µ–∑–¥
5. **üíº –û–ª–∏–≥–∞—Ä—Ö (oligarch)** - –±–æ–≥–∞—á, —è—Ö—Ç—ã –∏ –º–∏–ª–ª–∏–æ–Ω—ã
6. **üòÇ –°—Ç–µ–Ω–¥–∞–ø–µ—Ä (comedian)** - –∫–æ–º–∏–∫, –≤—Å—ë –≤ —à—É—Ç–∫—É
7. **üî¨ –£—á—ë–Ω—ã–π (scientist)** - –Ω–∞—É—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

**–ö–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–∏ (–¥–æ 5 —à—Ç—É–∫)
- Sanitization –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç prompt injection
- –ó–∞–ø—Ä–µ—â–µ–Ω—ã –∏–º–µ–Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ª—é–¥–µ–π

---

## üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
TELEGRAM_BOT_TOKEN=123456:ABC-DEF...
ANTHROPIC_API_KEY=sk-ant-...
ANTHROPIC_MODEL=claude-3-7-sonnet-20250219
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_KEY=eyJhbGci...

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
SECRET_KEY=random_secret_for_hmac_12345

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
MESSAGE_RETENTION_DAYS=2                    # –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
DEFAULT_SUMMARY_HOURS=24
DEFAULT_PERSONALITY=neutral                 # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è /sut
COOLDOWN_SECONDS=60
RATE_LIMIT_REQUESTS=10
RATE_LIMIT_WINDOW=60
MAX_MESSAGES_PER_SUMMARY=500
DEFAULT_MESSAGE_LIMIT=50
MAX_CUSTOM_PERSONALITIES_PER_USER=5
MAX_PERSONALITY_DESCRIPTION_LENGTH=500
MIN_PERSONALITY_DESCRIPTION_LENGTH=10
LOG_LEVEL=INFO

# NEW: Direct chat settings
DIRECT_CHAT_CONTEXT_MESSAGES=30             # –°–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
DIRECT_CHAT_SESSION_TIMEOUT=900             # 15 –º–∏–Ω—É—Ç (–¥–ª—è –≥—Ä—É–ø–ø)
NO_DEFAULT_PERSONALITY=true                 # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –ª–∏—á–Ω–æ—Å—Ç–∏
DEFAULT_GREETING_ENABLED=true               # –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ API

# NEW: Group chat settings
GROUP_CHAT_WELCOME_IMAGE_ID=                # file_id –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è welcome
GROUP_ADD_URL=https://t.me/YourBot?startgroup=true
CHAT_SESSION_COOLDOWN=30                    # 30 —Å–µ–∫ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏ /chat
```

### –í–∞–∂–Ω–æ –¥–ª—è Vercel

**Environment Variables** –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ Vercel Dashboard:
- Settings ‚Üí Environment Variables
- –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Production, Preview, Development
- –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–¥–µ–ª–∞—Ç—å redeploy

---

## üîÑ –ê–í–¢–û–£–î–ê–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô

**–ú–µ—Ö–∞–Ω–∏–∑–º:**
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –≤ —á–∞—Ç–µ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ `MESSAGE_RETENTION_DAYS` (2 –¥–Ω—è)
- –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞ (–Ω–µ –≥–ª–æ–±–∞–ª—å–Ω–æ)
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `services/db_service.py:46-57`

**Cleanup —Å–∫—Ä–∏–ø—Ç:** `scripts/cleanup_old_messages.py`
- –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–Ω–µ –Ω–∞ Vercel!)
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ `README_CLEANUP.md`

---

## üöÄ DEPLOYMENT

### Vercel Setup

```bash
# Deploy
vercel deploy --prod

# Set environment variables —á–µ—Ä–µ–∑ Dashboard:
# Settings ‚Üí Environment Variables

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook
curl "https://api.telegram.org/bot<TOKEN>/setWebhook?url=https://vkratse.vercel.app"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook
curl "https://api.telegram.org/bot<TOKEN>/getWebhookInfo"
```

### Deployment Checklist

**–ü–µ—Ä–µ–¥ deployment:**
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] –ö–æ–º–∞–Ω–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç Latin –Ω–∞–∑–≤–∞–Ω–∏—è
- [ ] Application.initialize() –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- [ ] Pure WSGI –±–µ–∑ Werkzeug
- [ ] Environment variables —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ Vercel

**–ü–æ—Å–ª–µ deployment:**
- [ ] –õ–æ–≥–∏ Vercel –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç 200 OK
- [ ] Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ production URL
- [ ] getWebhookInfo –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–æ–∫
- [ ] –ö–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç: /start, /help, /sut

---

## üéØ –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

**Production bot:** @chto_bilo_v_chate_bot
**URL:** https://vkratse.vercel.app
**Deployment:** Vercel Serverless
**Database:** Supabase PostgreSQL

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏—á–∏:**
- ‚úÖ Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã: /start, /help, /sut, /rassudi, /lichnost, /stats
- ‚úÖ –°–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –≤ –≥—Ä—É–ø–ø–∞—Ö –∏ –õ–° (—Å –≤—ã–±–æ—Ä–æ–º —á–∞—Ç–∞)
- ‚úÖ 7 –±–∞–∑–æ–≤—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π (—á–µ—Ä–µ–∑ ConversationHandler)
- ‚úÖ –°—É–¥–µ–π—Å—Ç–≤–æ —Å–ø–æ—Ä–æ–≤
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã (/sut 2h, /sut today)
- ‚úÖ –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (2 –¥–Ω—è)
- ‚úÖ Rate limiting –∏ cooldown
- ‚úÖ HMAC –∑–∞—â–∏—Ç–∞ callback_data
- ‚úÖ Sanitization –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π
- ‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (—Ç–∞–±–ª–∏—Ü–∞ analytics)
- ‚úÖ User data persistence
- ‚úÖ Cleanup —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏

### üî® –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ / TODO (NEW FLOW)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–ª–æ—É):**
- [ ] –ú–æ–¥—É–ª—å `direct_chat.py` - –ø—Ä—è–º–æ–µ –æ–±—â–µ–Ω–∏–µ 1-–Ω–∞-1
  - [ ] `show_personality_selection()` - –ø–æ–∫–∞–∑ –º–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–µ–π
  - [ ] `set_personality()` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ + –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
  - [ ] `handle_message()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
  - [ ] `start_group_chat_session()` - –∑–∞–ø—É—Å–∫ /chat –≤ –≥—Ä—É–ø–ø–µ
  - [ ] `handle_group_chat_message()` - –æ—Ç–≤–µ—Ç—ã –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏
  - [ ] –ê–≤—Ç–æ–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç

- [ ] –ú–æ–¥—É–ª—å `onboarding.py` - welcome –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—ã
  - [ ] `show_add_to_group()` - CTA —Å –∫–Ω–æ–ø–∫–æ–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
  - [ ] `send_group_welcome()` - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
  - [ ] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è `my_chat_member`

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `modules/commands.py`
  - [ ] `/start` - –¥–æ–±–∞–≤–∏—Ç—å inline-–º–µ–Ω—é (üí¨ –û–±—â–∞—Ç—å—Å—è / üë• –î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É / üé≠ –õ–∏—á–Ω–æ—Å—Ç—å)
  - [ ] `/stop` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ /chat

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `modules/summaries.py`
  - [ ] `/summary` - –Ω–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –≤—ã–±–æ—Ä–æ–º –ª–∏—á–Ω–æ—Å—Ç–∏
  - [ ] Inline-–º–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–µ–π –≤ –≥—Ä—É–ø–ø–∞—Ö

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `modules/judge.py`
  - [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ª–∏—á–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –≤–µ—Ä–¥–∏–∫—Ç–æ–º

- [ ] –ë–î –º–∏–≥—Ä–∞—Ü–∏–∏
  - [ ] `sql/migrations/001_add_greetings.sql` - –¥–æ–±–∞–≤–∏—Ç—å `greeting_message`
  - [ ] `sql/migrations/002_chat_sessions.sql` - —Ç–∞–±–ª–∏—Ü–∞ `active_chat_sessions`
  - [ ] –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è 7 –±–∞–∑–æ–≤—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `services/ai_service.py`
  - [ ] `generate_chat_response()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–∏–∞–ª–æ–≥–∞
  - [ ] `generate_greeting()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `services/db_service.py`
  - [ ] `get_chat_history()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N —Å–æ–æ–±—â–µ–Ω–∏–π —Å –±–æ—Ç–æ–º
  - [ ] `create_chat_session()` - —Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏
  - [ ] `end_chat_session()` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
  - [ ] `get_active_session()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–£–ª—É—á—à–µ–Ω–∏—è UX):**
- [ ] –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è –≤—Å–µ—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π
- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π —á–µ—Ä–µ–∑ Claude API –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å user-friendly —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ (–ø–∞—Ä—Å–∏–Ω–≥ @username, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ë—É–¥—É—â–∏–µ —Ñ–∏—á–∏):**
- [ ] –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Tribute (–ü–û–°–õ–ï —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- [ ] –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –ª–∏—á–Ω–æ—Å—Ç—è–º
- [ ] –≠–∫—Å–ø–æ—Ä—Ç —Å–∞–º–º–∞—Ä–∏ –≤ —Ñ–∞–π–ª—ã
- [ ] Scheduled summaries (–∫—Ä–æ–Ω-–∑–∞–¥–∞—á–∏)
- [ ] Premium —Ñ—É–Ω–∫—Ü–∏–∏
- [ ] –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (voice ‚Üí text ‚Üí –æ—Ç–≤–µ—Ç)
- [ ] –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å (EN, RU, etc.)

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ù–û–í–û–ì–û —Ñ–ª–æ—É (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1):

**1. –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç –≤ –õ–°:**
- [ ] /start –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + inline-–º–µ–Ω—é (üí¨ –û–±—â–∞—Ç—å—Å—è / üë• –î–æ–±–∞–≤–∏—Ç—å / üé≠ –õ–∏—á–Ω–æ—Å—Ç—å)
- [ ] –ö–ª–∏–∫ "üí¨ –û–±—â–∞—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É—é" ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–µ–π
- [ ] –ö–ª–∏–∫ –Ω–∞ –ª–∏—á–Ω–æ—Å—Ç—å ‚Üí –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –≤ —Å—Ç–∏–ª–µ –ª–∏—á–Ω–æ—Å—Ç–∏
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å –µ—â—ë 10 —Å–æ–æ–±—â–µ–Ω–∏–π ‚Üí –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- [ ] /lichnost ‚Üí –º–µ–Ω—é —Å–º–µ–Ω—ã –ª–∏—á–Ω–æ—Å—Ç–∏
- [ ] –°–º–µ–Ω–∏—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å ‚Üí –∏—Å—Ç–æ—Ä–∏—è –ù–ï –æ—á–∏—â–∞–µ—Ç—Å—è, —Å—Ç–∏–ª—å –º–µ–Ω—è–µ—Ç—Å—è
- [ ] –ö–ª–∏–∫ "‚ûï –°–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å" ‚Üí ConversationHandler —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é ‚Üí –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ API

**2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É:**
- [ ] –ö–ª–∏–∫ "üë• –î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç" ‚Üí CTA-—Å–æ–æ–±—â–µ–Ω–∏–µ + –∫–Ω–æ–ø–∫–∞
- [ ] –ö–ª–∏–∫ –∫–Ω–æ–ø–∫–∏ ‚Üí Telegram –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å –≥—Ä—É–ø–ø—É
- [ ] –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞ ‚Üí welcome-—Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ
- [ ] Welcome —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–º–∞–Ω–¥—ã: /summary, /chat, /rassudi

**3. –ö–æ–º–∞–Ω–¥—ã –≤ –≥—Ä—É–ø–ø–µ:**
- [ ] /summary –≤ –≥—Ä—É–ø–ø–µ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–µ–π
- [ ] –ö–ª–∏–∫ –Ω–∞ –ª–∏—á–Ω–æ—Å—Ç—å ‚Üí —Å–∞–º–º–∞—Ä–∏ –≤ —Å—Ç–∏–ª–µ –ª–∏—á–Ω–æ—Å—Ç–∏
- [ ] /summary 100 ‚Üí —Å–∞–º–º–∞—Ä–∏ 100 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] /summary 2h ‚Üí —Å–∞–º–º–∞—Ä–∏ –∑–∞ 2 —á–∞—Å–∞
- [ ] /chat ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–µ–π
- [ ] –ö–ª–∏–∫ –Ω–∞ –ª–∏—á–Ω–æ—Å—Ç—å ‚Üí "–ü–∏—à–∏ –º–Ω–µ —á–µ—Ä–µ–∑ reply/mention"
- [ ] Reply –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ ‚Üí –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç
- [ ] @bot_mention —Ç–µ–∫—Å—Ç ‚Üí –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç
- [ ] –î—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç ‚Üí –±–æ—Ç –ù–ï –æ—Ç–≤–µ—á–∞–µ—Ç (–Ω–µ –µ–≥–æ —Å–µ—Å—Å–∏—è)
- [ ] –ñ–¥—ë–º 15 –º–∏–Ω—É—Ç ‚Üí —Å–µ—Å—Å–∏—è –∞–≤—Ç–æ–∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
- [ ] /stop ‚Üí —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é
- [ ] /rassudi @user1 @user2 —Å–ø–æ—Ä ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–µ–π
- [ ] –ö–ª–∏–∫ –Ω–∞ –ª–∏—á–Ω–æ—Å—Ç—å ‚Üí –≤–µ—Ä–¥–∏–∫—Ç –≤ —Å—Ç–∏–ª–µ –ª–∏—á–Ω–æ—Å—Ç–∏

**4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –±–µ–∑ –≤—ã–±–æ—Ä–∞ –ª–∏—á–Ω–æ—Å—Ç–∏ ‚Üí –ø–æ–¥—Å–∫–∞–∑–∫–∞ "/lichnost"
- [ ] /summary –≤ –ø—É—Å—Ç–æ–º —á–∞—Ç–µ ‚Üí "–ù–∞–ø–∏—à–∏—Ç–µ —Ö–æ—Ç—è –±—ã 10 —Å–æ–æ–±—â–µ–Ω–∏–π"
- [ ] /rassudi –±–µ–∑ @username ‚Üí –ø–æ–¥—Å–∫–∞–∑–∫–∞ —Å –ø—Ä–∏–º–µ—Ä–æ–º
- [ ] /chat –∫–æ–≥–¥–∞ —Å–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞ ‚Üí "–°–µ—Å—Å–∏—è —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞, /stop –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è"
- [ ] Cooldown –∞–∫—Ç–∏–≤–µ–Ω ‚Üí "–ü–æ–¥–æ–∂–¥–∏ X —Å–µ–∫—É–Ω–¥"

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ LEGACY —Ñ—É–Ω–∫—Ü–∏–π:

5. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –≥—Ä—É–ø–ø—É —Å –¥—Ä—É–∑—å—è–º–∏
6. –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞
7. –ù–∞–ø–∏—Å–∞—Ç—å 50+ —Å–æ–æ–±—â–µ–Ω–∏–π
8. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã:
   - [ ] /start –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
   - [ ] /help –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É
   - [ ] /sut –≤ –≥—Ä—É–ø–ø–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - [ ] /sut –≤ –õ–° –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ —á–∞—Ç–æ–≤
   - [ ] –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ ‚Üí —Å–∞–º–º–∞—Ä–∏ –≤ –õ–°
   - [ ] /rassudi –≤—ã–¥–∞—ë—Ç –≤–µ—Ä–¥–∏–∫—Ç
   - [ ] /lichnost –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–∏—á–Ω–æ—Å—Ç–∏
   - [ ] –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - [ ] /stats –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
9. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ (–ø–æ–¥–æ–∂–¥–∞—Ç—å 2 –¥–Ω—è)
10. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞—Å–ø–∞–º–∏—Ç—å (cooldown –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–±–æ—Ç–∞—Ç—å)
11. –£–¥–∞–ª–∏—Ç—å –±–æ—Ç–∞ (–¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –æ—á–∏—Å—Ç–∏—Ç—å—Å—è)

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- [ ] HMAC –ø–æ–¥–ø–∏—Å–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è
- [ ] –ù–µ–ª—å–∑—è –ø–æ–ª—É—á–∏—Ç—å —Å–∞–º–º–∞—Ä–∏ —á–∞—Ç–∞ –≥–¥–µ –Ω–µ —Å–æ—Å—Ç–æ–∏—à—å
- [ ] Rate limiting –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–ø–∞–º
- [ ] Cooldown –±–ª–æ–∫–∏—Ä—É–µ—Ç —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —á–∞—Ç–µ
- [ ] Sanitization –±–ª–æ–∫–∏—Ä—É–µ—Ç prompt injection
- [ ] –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å —Å –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏

---

## üí° –ö–õ–Æ–ß–ï–í–´–ï –ú–û–ú–ï–ù–¢–´ –î–õ–Ø CLAUDE

### –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∫–æ–¥–æ–º:

1. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –∫–∞–∂–¥–∞—è —Ñ–∏—á–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –º–æ–¥—É–ª–µ
2. **–¢–∏–ø–∏–∑–∞—Ü–∏—è** - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å type hints
3. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏** - docstrings –≤–µ–∑–¥–µ
4. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** - –≤—Å—ë —á–µ—Ä–µ–∑ config.py
5. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –≤—Å–µ–≥–¥–∞ sanitize –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥
6. **–ü—Ä–æ–≤–µ—Ä–∫–∏** - –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —á–ª–µ–Ω—Å—Ç–≤–æ –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç—É–ø–æ–º –∫ –¥–∞–Ω–Ω—ã–º
7. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
8. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - try/except –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API

### –í–∞–∂–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

- –ö–æ–º–∞–Ω–¥—ã —Ç–æ–ª—å–∫–æ –Ω–∞ LATIN (Telegram API requirement)
- Pure WSGI (–±–µ–∑ Werkzeug –¥–ª—è Vercel)
- Application.initialize() –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- Graceful degradation –¥–ª—è –∏–º–ø–æ—Ä—Ç–æ–≤
- HMAC –¥–ª—è callback_data –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- Rate limiting –∏ cooldown –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∞–±—É–∑–∞

### –°–ø–µ—Ü–∏—Ñ–∏–∫–∞ –ù–û–í–û–ì–û —Ñ–ª–æ—É:

1. **–ù–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –í–°–ï–ì–î–ê –≤—ã–±–∏—Ä–∞–µ—Ç —è–≤–Ω–æ
2. **Inline-–º–µ–Ω—é –≤–µ–∑–¥–µ** - –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ callback_query —Å –∫–Ω–æ–ø–∫–∞–º–∏
3. **–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏** - —Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–≤—è–∑–Ω–æ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥–∞
4. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è** - –∫–∞–∂–¥–∞—è –ª–∏—á–Ω–æ—Å—Ç—å –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
5. **–°–µ—Å—Å–∏–∏ —á–∞—Ç–∞** - –¥–ª—è /chat –≤ –≥—Ä—É–ø–ø–∞—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ bot_data
6. **User-friendly –æ—à–∏–±–∫–∏** - –≤—Å–µ–≥–¥–∞ –¥–∞–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ
7. **HMAC –¥–ª—è –≤—Å–µ–≥–æ** - –ª—é–±–æ–π callback_data –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω
8. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ API** - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏

### –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ —Ñ–ª–æ—É:

**–§–∞–∑–∞ 1: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–ë–î + —Å–µ—Ä–≤–∏—Å—ã)**
1. SQL –º–∏–≥—Ä–∞—Ü–∏–∏ (–¥–æ–±–∞–≤–∏—Ç—å greeting_message, active_chat_sessions)
2. –û–±–Ω–æ–≤–∏—Ç—å `db_service.py` (chat history, sessions)
3. –û–±–Ω–æ–≤–∏—Ç—å `ai_service.py` (chat response, greetings)

**–§–∞–∑–∞ 2: –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (direct chat)**
1. –°–æ–∑–¥–∞—Ç—å `direct_chat.py` (personality selection, message handling)
2. –û–±–Ω–æ–≤–∏—Ç—å `/start` –≤ `commands.py` (inline-–º–µ–Ω—é)
3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ 1-–Ω–∞-1 –æ–±—â–µ–Ω–∏—è –≤ –õ–°

**–§–∞–∑–∞ 3: –ì—Ä—É–ø–ø–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**
1. –°–æ–∑–¥–∞—Ç—å `onboarding.py` (welcome messages)
2. –î–æ–±–∞–≤–∏—Ç—å `/summary` –≤ `summaries.py`
3. –î–æ–±–∞–≤–∏—Ç—å `/chat` –≤ `direct_chat.py`
4. –û–±–Ω–æ–≤–∏—Ç—å `/rassudi` –≤ `judge.py` (–º–µ–Ω—é –ª–∏—á–Ω–æ—Å—Ç–µ–π)
5. –î–æ–±–∞–≤–∏—Ç—å `/stop` –≤ `commands.py`

**–§–∞–∑–∞ 4: –ü–æ–ª–∏—Ä–æ–≤–∫–∞**
1. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è –≤—Å–µ—Ö 7 –ª–∏—á–Ω–æ—Å—Ç–µ–π
2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ñ–ª–æ—É
3. –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases
4. Deployment

### –ü—Ä–∏–º–µ—Ä—ã callback_data —Å—Ç—Ä—É–∫—Ç—É—Ä:

```python
# –í—ã–±–æ—Ä –ª–∏—á–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä—è–º–æ–≥–æ —á–∞—Ç–∞
callback_data = "select_personality:bydlan"

# –í—ã–±–æ—Ä –ª–∏—á–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–∞–º–º–∞—Ä–∏
callback_data = "summary_personality:bydlan:100"  # bydlan, 100 messages

# –í—ã–±–æ—Ä –ª–∏—á–Ω–æ—Å—Ç–∏ –¥–ª—è —Å—É–¥–µ–π—Å—Ç–≤–∞
callback_data = "judge_personality:gopnik:user_hash"

# –ó–∞–ø—É—Å–∫ —Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ
callback_data = "start_chat:philosopher"

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É (URL button)
url = "https://t.me/YourBot?startgroup=true"
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ direct chat:

```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥ –¥–ª—è handle_message()
def handle_message(update, context):
    user_id = update.effective_user.id
    chat_id = update.effective_chat.id
    message = update.message.text

    # 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ –ª–∏—á–Ω–æ—Å—Ç—å
    personality = db.get_user_personality(user_id)
    if not personality:
        return "–í—ã–±–µ—Ä–∏ –ª–∏—á–Ω–æ—Å—Ç—å: /lichnost"

    # 2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —é–∑–µ—Ä–∞
    db.save_message(chat_id, user_id, message)

    # 3. –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å–æ–æ–±—â–µ–Ω–∏–π)
    history = db.get_chat_history(chat_id, user_id, limit=30)

    # 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
    response = ai_service.generate_chat_response(
        personality=personality,
        history=history,
        message=message
    )

    # 5. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
    update.message.reply_text(response)
    db.save_message(chat_id, bot_id, response)
```

---

## üìö –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

- **README.md** - –æ—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
- **README_CLEANUP.md** - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ cleanup —Å–∫—Ä–∏–ø—Ç—É
- **CLAUDE.md** - —ç—Ç–æ—Ç —Ñ–∞–π–ª, –¥–ª—è Claude Code
- **sql/*.sql** - SQL —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ë–î

---

## üêõ –ò–ó–í–ï–°–¢–ù–´–ï –û–°–û–ë–ï–ù–ù–û–°–¢–ò

### Vercel Serverless Limitations

1. **No background tasks** - –Ω–µ–ª—å–∑—è –∑–∞–ø—É—Å–∫–∞—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
2. **Stateless** - –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ–∑–∞–≤–∏—Å–∏–º
3. **Timeout** - –º–∞–∫—Å–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–ø—Ä–æ—Å
4. **No cron jobs** - –¥–ª—è scheduled tasks –Ω—É–∂–µ–Ω –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å

### –†–µ—à–µ–Ω–∏—è:

- **–ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ** - –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
- **Cleanup —Å–∫—Ä–∏–ø—Ç** - –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ
- **User data** - —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ bot_data —á–µ—Ä–µ–∑ persistence
- **Cooldown** - in-memory, –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –±–ª–∞–≥–æ–¥–∞—Ä—è bot_data

---

## üîó –ü–û–õ–ï–ó–ù–´–ï –°–°–´–õ–ö–ò

- [python-telegram-bot docs](https://docs.python-telegram-bot.org/)
- [Anthropic Claude API](https://docs.anthropic.com/)
- [Supabase docs](https://supabase.com/docs)
- [Vercel Python runtime](https://vercel.com/docs/runtimes#official-runtimes/python)

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-11-12
**–í–µ—Ä—Å–∏—è –±–æ—Ç–∞:** Production (NEW FLOW –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç ‚úÖ

---

## üìù CHANGELOG

### 2025-11-12: –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Ñ–ª–æ—É
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª **Customer Journey Map (CJM)**
- ‚úÖ –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã 2 –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—É—Ç–∏: –ª–∏—á–Ω—ã–π —á–∞—Ç + –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç
- ‚úÖ –û–ø–∏—Å–∞–Ω—ã –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã: `/summary`, `/chat`, `/stop`
- ‚úÖ –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π: `direct_chat.py`, `onboarding.py`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –ë–î: `active_chat_sessions`, `greeting_message`
- ‚úÖ –û–ø–∏—Å–∞–Ω—ã –≤—Å–µ UX-—Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –°–æ–∑–¥–∞–Ω TODO-–ª–∏—Å—Ç –¥–ª—è –ø–æ—ç—Ç–∞–ø–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (4 —Ñ–∞–∑—ã)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –∏ callback_data —Å—Ç—Ä—É–∫—Ç—É—Ä
- üî® –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: –§–∞–∑–∞ 1 ‚Üí –§–∞–∑–∞ 2 ‚Üí –§–∞–∑–∞ 3 ‚Üí –§–∞–∑–∞ 4

### 2025-11-14: –ü—Ä–µ–¥—ã–¥—É—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ cleanup —Å–∫—Ä–∏–ø—Ç—É
- –°–æ–∫—Ä–∞—â—ë–Ω retention –¥–æ 2 –¥–Ω–µ–π
