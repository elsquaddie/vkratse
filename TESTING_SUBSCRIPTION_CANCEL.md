# Testing Subscription Cancellation

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –æ—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
- ‚úÖ Telegram Stars
- ‚úÖ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã (YooKassa)
- ‚úÖ Dry run —Ä–µ–∂–∏–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –ò–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
- –ü–æ—è–≤–ª—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–∫—Ç–∏–≤–Ω–æ–π Pro –ø–æ–¥–ø–∏—Å–∫–æ–π
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ `/premium` –∫–æ–º–∞–Ω–¥–µ
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ callback `show_premium`

### 2. –ü—Ä–æ—Ü–µ—Å—Å –æ—Ç–º–µ–Ω—ã
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
2. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:
   - –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (Stars/–ö–∞—Ä—Ç–∞/Tribute)
   - –î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
   - –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –æ—Ç–º–µ–Ω—ã
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç "‚úÖ –î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å" –∏–ª–∏ –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "‚ùå –ù–µ—Ç, –æ—Å—Ç–∞–≤–∏—Ç—å"
4. –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏:
   - –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –≤ –ë–î (`is_active = false`)
   - –ë–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏ (Pro->Free)
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ Free —Ç–∞—Ä–∏—Ñ

### 3. Dry Run —Ä–µ–∂–∏–º
–í —Ä–µ–∂–∏–º–µ `PAYMENT_DRY_RUN=true`:
- –û—Ç–º–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –ø–ª–∞—Ç–µ–∂–Ω—ã–º —Å–∏—Å—Ç–µ–º–∞–º
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–µ–∫—Å—Ç "(DRY RUN)" –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
- –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `[DRY RUN]`

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Dry Run

### –®–∞–≥ 1: –í–∫–ª—é—á–∏—Ç—å Dry Run
```bash
# –í .env –∏–ª–∏ Vercel Environment Variables:
PAYMENT_DRY_RUN=true
```

### –®–∞–≥ 2: –ü–æ–ª—É—á–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É
1. –û—Ç–∫—Ä–æ–π –±–æ—Ç–∞ –≤ Telegram
2. –ù–∞–ø–∏—à–∏ `/premium`
3. –ù–∞–∂–º–∏ "üí≥ –ö—É–ø–∏—Ç—å Pro"
4. –í—ã–±–µ—Ä–∏ –ª—é–±–æ–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (Stars –∏–ª–∏ –ö–∞—Ä—Ç–∞)
5. –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ

### –®–∞–≥ 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–º–µ–Ω—É
1. –ù–∞–ø–∏—à–∏ `/premium` —Å–Ω–æ–≤–∞
2. –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
3. –ù–∞–∂–º–∏ –Ω–∞ –Ω–µ—ë
4. –ü—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—Å—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:
   - –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π?
   - –î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è?
   - –í—Å–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –Ω–∞ –º–µ—Å—Ç–µ?
5. –ù–∞–∂–º–∏ "‚úÖ –î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å"
6. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–º–µ–Ω–µ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–µ–∫—Å—Ç "DRY RUN")
7. –ù–∞–ø–∏—à–∏ `/mystatus` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Free —Ç–∞—Ä–∏—Ñ

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ–ø–∞–ª–∞
1. –ù–∞–ø–∏—à–∏ `/premium` –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã
2. –ö–Ω–æ–ø–∫–∞ "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" –ù–ï –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–ª—è—Ç—å—Å—è
3. –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ "üí≥ –ö—É–ø–∏—Ç—å Pro"

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Production

### –í–∞–∂–Ω–æ!
‚ö†Ô∏è **–ü–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–Ω-—Ç–µ—Å—Ç–æ–º —É–±–µ–¥–∏—Å—å:**
- `PAYMENT_DRY_RUN=false` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ï—Å—Ç—å —Ä–µ–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ (–æ–ø–ª–∞—á–µ–Ω–Ω–∞—è Stars –∏–ª–∏ –∫–∞—Ä—Ç–æ–π)

### –ü—Ä–æ—Ü–µ—Å—Å
1. –ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∞–ª—å–Ω—É—é Pro –ø–æ–¥–ø–∏—Å–∫—É
2. –ù–∞–ø–∏—à–∏ `/premium`
3. –ù–∞–∂–º–∏ "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
4. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –æ—Ç–º–µ–Ω—É
5. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ:
   - –ü–æ–¥–ø–∏—Å–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
   - –í –ë–î `is_active = false`
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ Free —Ç–∞—Ä–∏—Ñ–µ
   - –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã

### –û—Ç–∫–∞—Ç
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –æ—Ç–º–µ–Ω—É (–¥–ª—è —Ç–µ—Å—Ç–∞):
```sql
-- –í Supabase SQL Editor:
UPDATE subscriptions
SET is_active = true
WHERE user_id = YOUR_TELEGRAM_ID;
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### Dry Run
```
INFO: [DRY RUN] Cancelling subscription for user 123456789
INFO: Subscription deactivated for user 123456789
```

### Production
```
INFO: Cancelling subscription for user 123456789, payment_method=telegram_stars
INFO: Subscription deactivated for user 123456789
INFO: Subscription cancelled successfully for user 123456789
```

## FAQ

### Q: –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ª–∏ –¥–µ–Ω—å–≥–∏ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ?
A: –ù–µ—Ç. –ò Stars, –∏ YooKassa –ø–ª–∞—Ç–µ–∂–∏ –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ - —Ä–∞–∑–æ–≤—ã–µ (non-recurring). –û—Ç–º–µ–Ω–∞ –ø—Ä–æ—Å—Ç–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –≤ –ë–î.

### Q: –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏?
A: –í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ç —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫. –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ - —Ä–∞–∑–æ–≤—ã–µ –Ω–∞ 30 –¥–Ω–µ–π.

### Q: –ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É, –æ–ø–ª–∞—á–µ–Ω–Ω—É—é —á–µ—Ä–µ–∑ Tribute?
A: –î–∞, –ø—Ä–æ—Ü–µ—Å—Å –∏–¥–µ–Ω—Ç–∏—á–µ–Ω. –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –≤ –ë–î.

### Q: –ß—Ç–æ –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ —É–∂–µ –∏—Å—Ç–µ–∫–ª–∞?
A: –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

```
modules/commands.py
‚îú‚îÄ‚îÄ premium_command()
‚îÇ   ‚îî‚îÄ‚îÄ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö Pro
‚îÇ
‚îú‚îÄ‚îÄ handle_start_menu_callback()
‚îÇ   ‚îú‚îÄ‚îÄ show_premium (action)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö Pro
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ cancel_subscription (action) - –ù–û–í–´–ô
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –ü–æ–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–º–µ–Ω—ã
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ confirm_cancel_subscription (action) - –ù–û–í–´–ô
‚îÇ       ‚îú‚îÄ‚îÄ Dry run: –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –±–µ–∑ API
‚îÇ       ‚îî‚îÄ‚îÄ Real: –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
‚îÇ
services/db_service.py
‚îî‚îÄ‚îÄ deactivate_subscription() - —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è
    ‚îî‚îÄ‚îÄ –û–±–Ω–æ–≤–ª—è–µ—Ç is_active = false
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ HMAC –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –≤—Å–µ—Ö callback_data
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–º–µ–Ω–æ–π
‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è user_id
‚úÖ –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
‚úÖ Graceful error handling
‚úÖ Dry run —Ä–µ–∂–∏–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

- [ ] Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ
- [ ] –°–±–æ—Ä feedback –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ ("–ü–æ—á–µ–º—É –æ—Ç–º–µ–Ω—è–µ—à—å?")
- [ ] –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å "–∑–∞–º–æ—Ä–æ–∑–∏—Ç—å" –ø–æ–¥–ø–∏—Å–∫—É –≤–º–µ—Å—Ç–æ –æ—Ç–º–µ–Ω—ã
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–∏—á–∏–Ω –æ—Ç–º–µ–Ω—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
