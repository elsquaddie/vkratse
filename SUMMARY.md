# üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞: Security Fixes Roadmap

> **–°–æ–∑–¥–∞–Ω–æ:** 2025-11-18
> **–í–µ—Ç–∫–∞:** `claude/fix-critical-bugs-0116r3xkW13tvXPG1yQKKHUL`
> **–ö–æ–º–º–∏—Ç:** `eceedf4`

---

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

1. **SECURITY_FIXES.md** (2744 —Å—Ç—Ä–æ–∫)
   - –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è 10+ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤
   - –ö–∞–∂–¥—ã–π —à–∞–≥: –æ–ø–∏—Å–∞–Ω–∏–µ ‚Üí —Ñ–∏–∫—Å ‚Üí —Ç–µ—Å—Ç—ã ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞
   - –ì–æ—Ç–æ–≤–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –Ω–æ–≤–æ–º —á–∞—Ç–µ —Å Claude

2. **QUICKSTART_FIXES.md**
   - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–≥–∞–º–∏
   - –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ª–∏–Ω—Ç–∏–Ω–≥–∞
   - Troubleshooting guide

### üß™ –¢–µ—Å—Ç–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

1. **requirements-dev.txt**
   - pytest, pytest-cov, pytest-asyncio
   - flake8, black, mypy, isort
   - bandit, safety (security scanning)

2. **pytest.ini**
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤
   - –ü–æ–∫—Ä—ã—Ç–∏–µ 60%+ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
   - Markers –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ç–µ—Å—Ç–æ–≤

3. **tests/** —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
   - `tests/unit/` - —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã
   - `tests/integration/` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
   - `tests/security/` - security-—Ç–µ—Å—Ç—ã
   - `tests/e2e/` - end-to-end —Ç–µ—Å—Ç—ã
   - `conftest.py` - fixtures –∏ –º–æ–∫–∏

### üîß CI/CD –∏ Code Quality

1. **.github/workflows/test.yml**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –Ω–∞ –∫–∞–∂–¥—ã–π push
   - –õ–∏–Ω—Ç–∏–Ω–≥ (flake8, black)
   - Security scanning (bandit)
   - Coverage check (60%+)

2. **.pre-commit-config.yaml**
   - Pre-commit hooks
   - Auto-formatting
   - Secret detection

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –®–ê–ì 1: SQL Injection
- **–§–∞–π–ª:** `services/db_service.py:516`
- **–†–∏—Å–∫:** Data breach
- **–§–∏–∫—Å:** –ó–∞–º–µ–Ω–∏—Ç—å f-string –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é

### –®–ê–ì 2: –î–µ—Ñ–æ–ª—Ç–Ω—ã–π SECRET_KEY
- **–§–∞–π–ª:** `config.py:33`
- **–†–∏—Å–∫:** HMAC compromised
- **–§–∏–∫—Å:** –£–¥–∞–ª–∏—Ç—å default, —Ç—Ä–µ–±–æ–≤–∞—Ç—å env var

### –®–ê–ì 3: Race Condition
- **–§–∞–π–ª:** `api/index.py:644-646`
- **–†–∏—Å–∫:** –ó–∞–≤–µ—Ä—à–∞–µ—Ç —á—É–∂–∏–µ tasks
- **–§–∏–∫—Å:** –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ current_task()

### –®–ê–ì 4: Webhook Verification –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- **–§–∞–π–ª:** `api/index.py`
- **–†–∏—Å–∫:** Fake updates
- **–§–∏–∫—Å:** –ü—Ä–æ–≤–µ—Ä—è—Ç—å X-Telegram-Bot-Api-Secret-Token

### –®–ê–ì 5: –ë–ê–ì –≤ Cache TTL
- **–§–∞–π–ª:** `services/subscription.py:318`
- **–†–∏—Å–∫:** Cache —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
- **–§–∏–∫—Å:** `.total_seconds()` –≤–º–µ—Å—Ç–æ `.seconds`

### –®–ê–ì 6: YooKassa Handler –Ω–µ Async
- **–§–∞–π–ª:** `api/yookassa_webhook.py:67-142`
- **–†–∏—Å–∫:** –ü–ª–∞—Ç–µ–∂–∏ –ù–ï –†–ê–ë–û–¢–ê–Æ–¢
- **–§–∏–∫—Å:** –°–¥–µ–ª–∞—Ç—å `async def handler()`

### –®–ê–ì 7: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Idempotency
- **–§–∞–π–ª—ã:** `api/index.py`, `api/yookassa_webhook.py`
- **–†–∏—Å–∫:** Duplicate processing
- **–§–∏–∫—Å:** –¢–∞–±–ª–∏—Ü–∞ `webhook_log` —Å UNIQUE constraint

### –®–ê–ì 8: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HMAC Signatures
- **–§–∞–π–ª:** `utils/security.py:73,100`
- **–†–∏—Å–∫:** Signature leak
- **–§–∏–∫—Å:** –£–¥–∞–ª–∏—Ç—å –ª–æ–≥–∏ –∏–ª–∏ redact

### –®–ê–ì 9: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Retry
- **–§–∞–π–ª—ã:** `services/db_service.py`, `services/ai_service.py`
- **–†–∏—Å–∫:** Data loss –ø—Ä–∏ network failures
- **–§–∏–∫—Å:** –î–æ–±–∞–≤–∏—Ç—å `@retry` –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä

### –®–ê–ì 10: Connection Pooling –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- **–§–∞–π–ª:** `services/db_service.py:17-22`
- **–†–∏—Å–∫:** Resource leak, –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- **–§–∏–∫—Å:** Singleton pattern –¥–ª—è Supabase client

---

## üöÄ –ö–∞–∫ –Ω–∞—á–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å

### –í–∞—Ä–∏–∞–Ω—Ç 1: –í –Ω–æ–≤–æ–º —á–∞—Ç–µ —Å Claude

```
–ü—Ä–∏–≤–µ—Ç! –Ø —Ä–∞–±–æ—Ç–∞—é –Ω–∞–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –±–∞–≥–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ vkratse.

–û—Ç–∫—Ä—ã–π —Ñ–∞–π–ª SECURITY_FIXES.md –∏ —Å–¥–µ–ª–∞–π –®–ê–ì 1.

–°–æ–∑–¥–∞–π –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã:
1. –ü—Ä–∏–º–µ–Ω–∏ —Ñ–∏–∫—Å
2. –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç—ã
3. –ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç—ã
4. –°–æ–∑–¥–∞–π –∫–æ–º–º–∏—Ç

–ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—à—å - –æ—Ç–º–µ—Ç—å —á–µ–∫–±–æ–∫—Å ‚úÖ –≤ SECURITY_FIXES.md.
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

```bash
# 1. Checkout –≤–µ—Ç–∫—É
git checkout claude/fix-critical-bugs-0116r3xkW13tvXPG1yQKKHUL

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements-dev.txt

# 3. –û—Ç–∫—Ä–æ–π SECURITY_FIXES.md
# 4. –î–µ–ª–∞–π —à–∞–≥–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
# 5. –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞:
pytest tests/ -v
git add . && git commit -m "fix: [–æ–ø–∏—Å–∞–Ω–∏–µ]"
```

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö 10 —à–∞–≥–æ–≤:

- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** SQL injection, HMAC, webhook verification - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** Retry, idempotency, connection pooling - –¥–æ–±–∞–≤–ª–µ–Ω—ã
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** Cleanup optimization, caching - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å:** 60%+ coverage - –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ
- ‚úÖ **Production-ready:** –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

---

## üìö –°—Å—ã–ª–∫–∏

- **–û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–∞–Ω:** [SECURITY_FIXES.md](SECURITY_FIXES.md)
- **–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:** [QUICKSTART_FIXES.md](QUICKSTART_FIXES.md)
- **Pull Request:** https://github.com/elsquaddie/vkratse/pull/new/claude/fix-critical-bugs-0116r3xkW13tvXPG1yQKKHUL

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–æ—á–∏—Ç–∞–π **QUICKSTART_FIXES.md**
2. –£—Å—Ç–∞–Ω–æ–≤–∏ dev-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
3. –ù–∞—á–Ω–∏ —Å **–®–ê–ì 1** –≤ **SECURITY_FIXES.md**
4. –î–µ–ª–∞–π –ø–æ –æ–¥–Ω–æ–º—É —à–∞–≥—É –∑–∞ —Ä–∞–∑
5. –¢–µ—Å—Ç–∏—Ä—É–π –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
6. –ö–æ–º–º–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

---

**–£–¥–∞—á–∏! üöÄ**

–í–æ–ø—Ä–æ—Å—ã? –û—Ç–∫—Ä—ã–≤–∞–π –Ω–æ–≤—ã–π —á–∞—Ç —Å Claude –∏ —Å–ø—Ä–∞—à–∏–≤–∞–π –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —à–∞–≥–µ.
